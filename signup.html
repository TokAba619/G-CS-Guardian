<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G-CS Guardian Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Saira:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="test.css" />
</head>
<body>

  <!-- Brand-only bar (left aligned) -->
  <div class="brandbar">
    <a class="brand" href="index.html">
      <img src="logo.png" alt="G-CS Guardian logo" />
      <span class="title">G-CS Guardian</span>
    </a>
  </div>

  <div class="wrap">
    <section class="card" aria-labelledby="cardTitle">
      <div class="card-head">
        <img src="paper5.png" alt="Brand" class="card-logo" />
        <h1 id="cardTitle" class="card-title">Admin Login</h1>
        <p class="card-subtitle">To continue to G-CS Guardian</p>
      </div>

      <form id="loginForm" class="card-body" novalidate>
        <label class="field">
          <span class="field-label">Email address<span class="req">*</span></span>
          <input type="email" id="email" name="username" placeholder="name@company.com" required />
        </label>

        <label class="field">
          <span class="field-label">Password<span class="req">*</span></span>
          <input type="password" id="password" name="password" placeholder="••••••••" required />
        </label>

        <button type="submit" class="btn btn-primary">Login</button>

        <!-- EXACT wording/placement -->
        <p class="alt" style="margin-top:16px;">
          Join as a User<br />Login Below
        </p>

        <!-- Consent + inline error -->
        <div class="consent">
          <label class="checkbox" for="tncCheck">
            <input type="checkbox" id="tncCheck" />
            <span>I agree to the
              <a href="tnc.html" target="_self" rel="noopener">Terms &amp; Conditions</a>
              and
              <a href="privacy.html" target="_self" rel="noopener">Privacy Policy</a>.
            </span>
          </label>
          <div id="tncError" class="error">Please agree to the Terms &amp; Conditions to continue.</div>
        </div>

        <!-- Google OAuth button (disabled until T&C checked) -->
        <a
          id="googleLogin"
          class="btn btn-google disabled"
          href="https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/auth/login"
          aria-disabled="true"
        >
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="" />
          <span>Login with Google</span>
        </a>

        <!-- Admin login error -->
        <div id="error" class="error" role="alert"></div>
      </form>
    </section>
  </div>

  <script>
    // ===== Google OAuth T&C enforcement =====
    const tncCheck   = document.getElementById('tncCheck');
    const googleLink = document.getElementById('googleLogin');
    const tncError   = document.getElementById('tncError');

    function updateGoogleState() {
      const ok = tncCheck.checked;
      googleLink.classList.toggle('disabled', !ok);
      googleLink.setAttribute('aria-disabled', String(!ok));
      if (ok) tncError.style.display = 'none';
    }
    updateGoogleState();
    tncCheck.addEventListener('change', updateGoogleState);

    googleLink.addEventListener('click', function (e) {
      if (googleLink.classList.contains('disabled')) {
        e.preventDefault();
        tncError.style.display = 'block';
        tncCheck.focus();
      }
    });

    // ===== Google OAuth redirect handling =====
    const urlParams = new URLSearchParams(window.location.search);
    const token  = urlParams.get("token");
    const email  = urlParams.get("email");
    const role   = urlParams.get("role");

    if (token) {
      localStorage.setItem("access_token", token);
      if (email) localStorage.setItem("email", email);
      if (role)  localStorage.setItem("role", role);
      window.location.href = "/G-CS-Guardian/web.html";
    }

    // ===== Admin email/password login =====
    document.getElementById("loginForm").addEventListener("submit", function (event) {
      event.preventDefault();
      login();
    });

    function login() {
      const emailVal = document.getElementById("email").value.trim();
      const passwordVal = document.getElementById("password").value;

      fetch("https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: emailVal, password: passwordVal }),
      })
      .then((res) => {
        if (!res.ok) throw new Error("Login failed");
        return res.json();
      })
      .then((data) => {
        if (data.access_token) {
          localStorage.setItem("access_token", data.access_token);
          if (data.email) localStorage.setItem("email", data.email);
          if (data.role)  localStorage.setItem("role", data.role);
          window.location.href = "/G-CS-Guardian/web.html";
        } else {
          document.getElementById("error").textContent = "Invalid email or password.";
          document.getElementById("error").style.display = "block";
        }
      })
      .catch((err) => {
        console.error("Login Error:", err);
        const el = document.getElementById("error");
        el.textContent = "Something went wrong. Try again.";
        el.style.display = "block";
      });
    }
  </script>
</body>
</html>
