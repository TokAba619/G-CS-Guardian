<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G-CS Guardian Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Saira:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="test.css" />
</head>
<body>

  <!-- Brand-only bar (left aligned) -->
  <div class="brandbar">
    <a class="brand" href="index.html">
      <img src="logo.png" alt="G-CS Guardian logo" />
      <span class="title">G-CS Guardian</span>
    </a>
  </div>

  <div class="wrap">
    <section class="card" aria-labelledby="cardTitle">
      <div class="card-head">
        <img src="logo1.png" alt="Brand" class="card-logo" />
        <h1 id="cardTitle" class="card-title">Admin / Google Login</h1>
        <p class="card-subtitle">To continue to G-CS Guardian</p>
      </div>

      <form id="loginForm" class="card-body" novalidate>
        <label class="field">
          <span class="field-label">Admin Email address<span class="req">*</span></span>
          <input type="email" id="email" name="username" placeholder="name@gmail.com" required />
        </label>

        <label class="field">
          <span class="field-label">Admin Password<span class="req">*</span></span>
          <input type="password" id="password" name="password" placeholder="••••••••" required />
        </label>

        <button type="submit" class="btn btn-primary">Login</button>

        <p class="alt" style="margin-top:16px;">
          Join as a User<br />Login Below
        </p>

        <!-- Consent + inline message -->
        <div class="consent">
          <label class="checkbox" for="tncCheck">
            <input type="checkbox" id="tncCheck" />
            <span>I agree to the
              <a href="TnC.html" target="_self" rel="noopener">Terms &amp; Conditions</a>
              and
              <a href="privacy.html" target="_self" rel="noopener">Privacy Policy</a>.
            </span>
          </label>
          <div id="tncError" class="error" style="display:none;">Please agree to the Terms &amp; Conditions to continue.</div>
        </div>

        <!-- Google OAuth button (disabled until user ticks consent) -->
        <a
          id="googleLogin"
          class="btn btn-google disabled"
          href="https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/auth/login"
          aria-disabled="true"
        >
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="" />
          <span>Login with Google</span>
        </a>

        <!-- Admin login error -->
        <div id="error" class="error" role="alert" style="display:none;"></div>
      </form>
    </section>
  </div>

  <script>
  // ===== Config =====
  const API_BASE                = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app";
  const CONSENT_ENDPOINT        = API_BASE + "/consent";
  const CONSENT_REVOKE_ENDPOINT = API_BASE + "/consent/revoke";
  const CONSENT_ME_ENDPOINT     = API_BASE + "/consent/me";
  const CONSENT_VERSION         = "pp-v1.0";

  // ===== Elements =====
  const tncCheck   = document.getElementById('tncCheck');
  const googleLink = document.getElementById('googleLogin');
  const tncError   = document.getElementById('tncError');

  // ===== Helpers =====
  function setGoogleEnabled(enabled) {
    googleLink.classList.toggle('disabled', !enabled);
    googleLink.setAttribute('aria-disabled', String(!enabled));
  }
  function showMsg(msg, color = '#d9534f') {
    tncError.textContent = msg;
    tncError.style.display = 'block';
    tncError.style.color = color;
  }
  function hideMsg() { tncError.style.display = 'none'; }

  function saveConsentLocally(version) {
    localStorage.setItem("consent_given", "true");
    localStorage.setItem("consent_version", version);
    localStorage.setItem("consent_at", new Date().toISOString());
  }
  function clearConsentLocally() {
    localStorage.removeItem("consent_given");
    localStorage.removeItem("consent_at");
    localStorage.removeItem("consent_version");
    localStorage.removeItem("consent_pending");
  }
  function hasLocalConsent() {
    return localStorage.getItem("consent_given") === "true" &&
           localStorage.getItem("consent_version") === CONSENT_VERSION;
  }
  function markPendingConsent() { localStorage.setItem("consent_pending", "true"); }
  function clearPendingConsent() { localStorage.removeItem("consent_pending"); }
  function isPendingConsent() { return localStorage.getItem("consent_pending") === "true"; }
  function getToken() { return localStorage.getItem("access_token"); }

  // ===== API calls (AUTH REQUIRED for consent on your backend) =====
  async function postConsentWithAuth() {
    const tok = getToken();
    if (!tok) throw new Error("No token for POST /consent");
    const res = await fetch(CONSENT_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": `Bearer ${tok}`
      },
      body: JSON.stringify({ version: CONSENT_VERSION })
    });
    if (!res.ok) throw new Error(`POST /consent -> HTTP ${res.status}`);
    try { await res.json(); } catch(_) {}
  }

  async function revokeConsentWithAuth() {
    const tok = getToken();
    if (!tok) return; // best-effort only before login
    const res = await fetch(CONSENT_REVOKE_ENDPOINT, {
      method: "POST",
      headers: {
        "Accept": "application/json",
        "Authorization": `Bearer ${tok}`
      }
    });
    if (!res.ok) throw new Error(`POST /consent/revoke -> HTTP ${res.status}`);
    try { await res.json(); } catch(_) {}
  }

  async function getConsentMe() {
    const tok = getToken();
    if (!tok) throw new Error("No token for GET /consent/me");
    const res = await fetch(CONSENT_ME_ENDPOINT, {
      method: "GET",
      headers: {
        "Accept": "application/json",
        "Authorization": `Bearer ${tok}`
      }
    });
    if (!res.ok) throw new Error(`GET /consent/me -> HTTP ${res.status}`);
    return res.json();
  }

  // Ensure backend records consent after login, then go to app.
  async function ensureConsentAfterAuth() {
    // If backend already has valid consent → go
    try {
      const data = await getConsentMe();
      if (data?.consent_given === true && data?.consent_version === CONSENT_VERSION) {
        hideMsg();
        window.location.href = "/G-CS-Guardian/web.html";
        return;
      }
    } catch (_) { /* continue to sync */ }

    // If we had ticked earlier, sync it now WITH JWT
    if (hasLocalConsent() || isPendingConsent()) {
      try {
        await postConsentWithAuth();
        clearPendingConsent();
        const recheck = await getConsentMe();
        if (recheck?.consent_given === true && recheck?.consent_version === CONSENT_VERSION) {
          window.location.href = "/G-CS-Guardian/web.html";
          return;
        }
      } catch (e) {
        console.warn("Sync consent after auth failed:", e);
      }
    }

    // Otherwise, require ticking now (while authenticated)
    setGoogleEnabled(false);
    tncCheck.checked = false;
    showMsg("Please agree to the Terms & Conditions to continue.", "#d9534f");
  }

  // ===== Bootstrap (pre-login UX) =====
  (function bootstrapConsent() {
    // Before login, enable Google only if user has ticked consent locally.
    if (hasLocalConsent()) {
      tncCheck.checked = true;
      setGoogleEnabled(true);
      hideMsg();
    } else {
      tncCheck.checked = false;
      setGoogleEnabled(false);
    }
  })();

  // ===== Checkbox handler =====
  tncCheck.addEventListener('change', async () => {
    // UNTICK: disable Google, clear local, try revoke later if logged in
    if (!tncCheck.checked) {
      setGoogleEnabled(false);
      clearConsentLocally();
      hideMsg();
      try { await revokeConsentWithAuth(); } catch (_) {}
      return;
    }

    // TICK: DO NOT call backend now (would 403). Save pending and enable Google.
    saveConsentLocally(CONSENT_VERSION);
    markPendingConsent();
    hideMsg();
    setGoogleEnabled(true); // user can now click "Login with Google"
  });

  // Block Google button until ticked
  googleLink.addEventListener('click', function (e) {
    if (googleLink.classList.contains('disabled')) {
      e.preventDefault();
      showMsg("Please agree to the Terms & Conditions to continue.", "#d9534f");
      tncCheck.focus();
    }
  });

  // ===== OAuth redirect handling =====
  const urlParams = new URLSearchParams(window.location.search);
  const token  = urlParams.get("token");
  const email  = urlParams.get("email");
  const role   = urlParams.get("role");

  (async function handleOAuthReturn() {
    if (!token) return;
    localStorage.setItem("access_token", token);
    if (email) localStorage.setItem("email", email);
    if (role)  localStorage.setItem("role", role);
    setGoogleEnabled(false); // we have a token now; proceed to consent check
    await ensureConsentAfterAuth(); // may redirect to web.html
  })();

  // ===== Admin email/password login =====
  document.getElementById("loginForm").addEventListener("submit", function (event) {
    event.preventDefault();
    login();
  });

  function login() {
    const emailVal = document.getElementById("email").value.trim();
    const passwordVal = document.getElementById("password").value;

    fetch(API_BASE + "/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: emailVal, password: passwordVal }),
    })
    .then((res) => {
      if (!res.ok) throw new Error("Login failed");
      return res.json();
    })
    .then(async (data) => {
      if (data.access_token) {
        localStorage.setItem("access_token", data.access_token);
        if (data.email) localStorage.setItem("email", data.email);
        if (data.role)  localStorage.setItem("role", data.role);
        await ensureConsentAfterAuth(); // may redirect to web.html
      } else {
        const el = document.getElementById("error");
        el.textContent = "Invalid email or password.";
        el.style.display = "block";
      }
    })
    .catch((err) => {
      console.error("Login Error:", err);
      const el = document.getElementById("error");
      el.textContent = "Something went wrong. Try again.";
      el.style.display = "block";
    });
  }
  </script>

</body>
</html>
