<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G-CS Guardian Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Saira:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="test.css" />
</head>
<body>

  <!-- Brand-only bar (left aligned) -->
  <div class="brandbar">
    <a class="brand" href="index.html">
      <img src="logo.png" alt="G-CS Guardian logo" />
      <span class="title">G-CS Guardian</span>
    </a>
  </div>

  <div class="wrap">
    <section class="card" aria-labelledby="cardTitle">
      <div class="card-head">
        <img src="logo1.png" alt="Brand" class="card-logo" />
        <h1 id="cardTitle" class="card-title">Admin Login</h1>
        <p class="card-subtitle">To continue to G-CS Guardian</p>
      </div>

      <form id="loginForm" class="card-body" novalidate>
        <label class="field">
          <span class="field-label">Email address<span class="req">*</span></span>
          <input type="email" id="email" name="username" placeholder="name@gmail.com" required />
        </label>

        <label class="field">
          <span class="field-label">Password<span class="req">*</span></span>
          <input type="password" id="password" name="password" placeholder="••••••••" required />
        </label>

        <button type="submit" class="btn btn-primary">Login</button>

        <!-- EXACT wording/placement -->
        <p class="alt" style="margin-top:16px;">
          Join as a User<br />Login Below
        </p>

        <!-- Consent + inline error -->
        <div class="consent">
          <label class="checkbox" for="tncCheck">
            <input type="checkbox" id="tncCheck" />
            <span>I agree to the
              <a href="TnC.html" target="_self" rel="noopener">Terms &amp; Conditions</a>
              and
              <a href="privacy.html" target="_self" rel="noopener">Privacy Policy</a>.
            </span>
          </label>
          <div id="tncError" class="error" style="display:none;">Please agree to the Terms &amp; Conditions to continue.</div>
        </div>

        <!-- Google OAuth button (disabled until T&C checked + consent recorded) -->
        <a
          id="googleLogin"
          class="btn btn-google disabled"
          href="https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/auth/login"
          aria-disabled="true"
        >
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="" />
          <span>Login with Google</span>
        </a>

        <!-- Admin login error -->
        <div id="error" class="error" role="alert" style="display:none;"></div>
      </form>
    </section>
  </div>

  <script>
  // ===== Config =====
  const CONSENT_ENDPOINT = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/consent";
  const CONSENT_VERSION  = "pp-v1.0";

  // ===== Elements =====
  const tncCheck   = document.getElementById('tncCheck');
  const googleLink = document.getElementById('googleLogin');
  const tncError   = document.getElementById('tncError');

  // ===== Helpers =====
  function setGoogleEnabled(enabled) {
    googleLink.classList.toggle('disabled', !enabled);
    googleLink.setAttribute('aria-disabled', String(!enabled));
  }

  function saveConsentLocally(version) {
    localStorage.setItem("consent_given", "true");
    localStorage.setItem("consent_version", version);
    localStorage.setItem("consent_at", new Date().toISOString());
  }

  function clearConsentLocally() {
    localStorage.removeItem("consent_given");
    localStorage.removeItem("consent_at");
    localStorage.removeItem("consent_version");
  }

  function hasValidStoredConsent() {
    return localStorage.getItem("consent_given") === "true" &&
           localStorage.getItem("consent_version") === CONSENT_VERSION;
  }

  // POST /consent with minimal payload { version: "pp-v1.0" }
  async function postConsent({withAuth=false} = {}) {
    const headers = { "Content-Type": "application/json", "Accept": "application/json" };
    const tok = localStorage.getItem("access_token");
    if (withAuth && tok) headers["Authorization"] = `Bearer ${tok}`;

    const body = { version: CONSENT_VERSION };

    const res = await fetch(CONSENT_ENDPOINT, {
      method: "POST",
      mode: "cors",
      credentials: "omit",
      headers,
      body: JSON.stringify(body)
    });

    // Accept 200 OK (possibly JSON) or 204 No Content as success
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    try { await res.json(); } catch(_) { /* no JSON is fine */ }
  }

  function showError(msg, color = '#d9534f') {
    tncError.textContent = msg;
    tncError.style.display = 'block';
    tncError.style.color = color;
  }

  function hideError() {
    tncError.style.display = 'none';
  }

  // Reuse stored consent if same version
  (function bootstrapConsent() {
    if (hasValidStoredConsent()) {
      tncCheck.checked = true;
      setGoogleEnabled(true);
      hideError();
    } else {
      tncCheck.checked = false;
      setGoogleEnabled(false);
    }
  })();

  // When user ticks the box → POST {version:"pp-v1.0"} immediately.
  tncCheck.addEventListener('change', async () => {
    if (!tncCheck.checked) {
      // Turn off + revoke local consent
      setGoogleEnabled(false);
      clearConsentLocally();
      hideError();
      return;
    }

    // Optimistically show progress and disable button while posting
    setGoogleEnabled(false);
    showError("Recording your consent…", "#f0ad4e");

    try {
      await postConsent({ withAuth: false });  // <— sends exactly {"version":"pp-v1.0"}
      saveConsentLocally(CONSENT_VERSION);
      hideError();
      setGoogleEnabled(true); // only enable after backend accepted consent
    } catch (e) {
      console.warn("Consent POST failed:", e);
      // Revert the tick so users don't proceed without server-confirmed consent
      tncCheck.checked = false;
      clearConsentLocally();
      setGoogleEnabled(false);

      // Helpful guidance
      showError(
        "Could not record consent. Please try again. If this keeps happening, check your internet connection or contact support.",
        "#d9534f"
      );
    }
  });

  // Block Google button until consent checkbox is on AND server accepted
  googleLink.addEventListener('click', function (e) {
    if (googleLink.classList.contains('disabled')) {
      e.preventDefault();
      showError("Please agree to the Terms & Conditions to continue.", "#d9534f");
      tncCheck.focus();
    }
  });

  // ===== OAuth redirect handling =====
  const urlParams = new URLSearchParams(window.location.search);
  const token  = urlParams.get("token");
  const email  = urlParams.get("email");
  const role   = urlParams.get("role");

  if (token) {
    localStorage.setItem("access_token", token);
    if (email) localStorage.setItem("email", email);
    if (role)  localStorage.setItem("role", role);

    // Head to the app page
    window.location.href = "/G-CS-Guardian/web.html";
  }

  // ===== Admin email/password login =====
  document.getElementById("loginForm").addEventListener("submit", function (event) {
    event.preventDefault();
    login();
  });

  function login() {
    const emailVal = document.getElementById("email").value.trim();
    const passwordVal = document.getElementById("password").value;

    fetch("https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: emailVal, password: passwordVal }),
    })
    .then((res) => {
      if (!res.ok) throw new Error("Login failed");
      return res.json();
    })
    .then(async (data) => {
      if (data.access_token) {
        localStorage.setItem("access_token", data.access_token);
        if (data.email) localStorage.setItem("email", data.email);
        if (data.role)  localStorage.setItem("role", data.role);

        window.location.href = "/G-CS-Guardian/web.html";
      } else {
        const el = document.getElementById("error");
        el.textContent = "Invalid email or password.";
        el.style.display = "block";
      }
    })
    .catch((err) => {
      console.error("Login Error:", err);
      const el = document.getElementById("error");
      el.textContent = "Something went wrong. Try again.";
      el.style.display = "block";
    });
  }
  </script>

</body>
</html>
