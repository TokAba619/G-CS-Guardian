<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G-CS Guardian Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Saira:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Styles -->
  <link rel="stylesheet" href="test.css" />
</head>
<body>

  <!-- Brand-only bar (left aligned) -->
  <div class="brandbar">
    <a class="brand" href="index.html">
      <img src="logo.png" alt="G-CS Guardian logo" />
      <span class="title">G-CS Guardian</span>
    </a>
  </div>

  <div class="wrap">
    <section class="card" aria-labelledby="cardTitle">
      <div class="card-head">
        <img src="logo1.png" alt="Brand" class="card-logo" />
        <h1 id="cardTitle" class="card-title">Admin / Google Login</h1>
        <p class="card-subtitle">To continue to G-CS Guardian</p>
      </div>

      <form id="loginForm" class="card-body" novalidate>
        <label class="field">
          <span class="field-label">Email address<span class="req">*</span></span>
          <input type="email" id="email" name="username" placeholder="name@gmail.com" required />
        </label>

        <label class="field">
          <span class="field-label">Password<span class="req">*</span></span>
          <input type="password" id="password" name="password" placeholder="••••••••" required />
        </label>

        <button type="submit" class="btn btn-primary">Login</button>

        <p class="alt" style="margin-top:16px;">
          Join as a User<br />Login Below
        </p>

        <!-- Consent + inline message -->
        <div class="consent">
          <label class="checkbox" for="tncCheck">
            <input type="checkbox" id="tncCheck" />
            <span>I agree to the
              <a href="TnC.html" target="_self" rel="noopener">Terms &amp; Conditions</a>
              and
              <a href="privacy.html" target="_self" rel="noopener">Privacy Policy</a>.
            </span>
          </label>
          <div id="tncError" class="error" style="display:none;">Please agree to the Terms &amp; Conditions to continue.</div>
        </div>

        <!-- Google OAuth button (disabled until server confirms consent OR user ticks & records) -->
        <a
          id="googleLogin"
          class="btn btn-google disabled"
          href="https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/auth/login"
          aria-disabled="true"
        >
          <img src="https://developers.google.com/identity/images/g-logo.png" alt="" />
          <span>Login with Google</span>
        </a>

        <!-- Admin login error -->
        <div id="error" class="error" role="alert" style="display:none;"></div>
      </form>
    </section>
  </div>

  <script>
  // ===== Config =====
  const API_BASE                = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app";
  const CONSENT_ENDPOINT        = API_BASE + "/consent";
  const CONSENT_REVOKE_ENDPOINT = API_BASE + "/consent/revoke";
  const CONSENT_ME_ENDPOINT     = API_BASE + "/consent/me";
  const CONSENT_VERSION         = "pp-v1.0";

  // ===== Elements =====
  const tncCheck   = document.getElementById('tncCheck');
  const googleLink = document.getElementById('googleLogin');
  const tncError   = document.getElementById('tncError');

  // ===== Helpers =====
  function setGoogleEnabled(enabled) {
    googleLink.classList.toggle('disabled', !enabled);
    googleLink.setAttribute('aria-disabled', String(!enabled));
  }
  function showMsg(msg, color = '#d9534f') {
    tncError.textContent = msg;
    tncError.style.display = 'block';
    tncError.style.color = color;
  }
  function hideMsg() { tncError.style.display = 'none'; }

  function saveConsentLocally(version) {
    localStorage.setItem("consent_given", "true");
    localStorage.setItem("consent_version", version);
    localStorage.setItem("consent_at", new Date().toISOString());
  }
  function clearConsentLocally() {
    localStorage.removeItem("consent_given");
    localStorage.removeItem("consent_at");
    localStorage.removeItem("consent_version");
  }
  function hasValidStoredConsent() {
    return localStorage.getItem("consent_given") === "true" &&
           localStorage.getItem("consent_version") === CONSENT_VERSION;
  }
  function getToken() { return localStorage.getItem("access_token"); }

  // ===== API calls =====
  // POST /consent with minimal payload { version: "pp-v1.0" }
  async function postConsent({withAuth=false} = {}) {
    const headers = { "Content-Type": "application/json", "Accept": "application/json" };
    const tok = getToken();
    if (withAuth && tok) headers["Authorization"] = `Bearer ${tok}`;

    const res = await fetch(CONSENT_ENDPOINT, {
      method: "POST",
      mode: "cors",
      credentials: "omit",
      headers,
      body: JSON.stringify({ version: CONSENT_VERSION })
    });
    if (!res.ok) throw new Error(`POST /consent -> HTTP ${res.status}`);
    try { await res.json(); } catch(_) {}
  }

  // POST /consent/revoke
  async function revokeConsent() {
    const headers = { "Accept": "application/json" };
    const tok = getToken();
    if (tok) headers["Authorization"] = `Bearer ${tok}`;

    const res = await fetch(CONSENT_REVOKE_ENDPOINT, {
      method: "POST",
      mode: "cors",
      credentials: "omit",
      headers
    });
    if (!res.ok) throw new Error(`POST /consent/revoke -> HTTP ${res.status}`);
    try { await res.json(); } catch(_) {}
  }

  // GET /consent/me
  async function getConsentMe() {
    const tok = getToken();
    if (!tok) throw new Error("No token for /consent/me");
    const res = await fetch(CONSENT_ME_ENDPOINT, {
      method: "GET",
      headers: {
        "Accept": "application/json",
        "Authorization": `Bearer ${tok}`
      }
    });
    if (!res.ok) throw new Error(`GET /consent/me -> HTTP ${res.status}`);
    return res.json();
  }

  // After we have a token, ensure backend confirms consent for this version.
  async function ensureConsentAfterAuth() {
    try {
      const data = await getConsentMe();
      const ok = data?.consent_given === true && data?.consent_version === CONSENT_VERSION;
      if (ok) {
        // Server confirms consent -> proceed to app
        hideMsg();
        window.location.href = "/G-CS-Guardian/web.html";
        return;
      }
      // Not ok: require user to tick now (with token, so POST will be attached to account)
      setGoogleEnabled(false);
      tncCheck.checked = false;
      showMsg("Please agree to the Terms & Conditions to continue.", "#d9534f");
    } catch (e) {
      // Could be 401/expired token or network. Keep user here with a helpful message.
      console.warn("ensureConsentAfterAuth:", e);
      setGoogleEnabled(false);
      tncCheck.checked = false;
      showMsg("We couldn't verify your consent. Please tick the box to continue.", "#f0ad4e");
    }
  }

  // ===== Bootstrap (pre-login UX) =====
  (function bootstrapConsent() {
    // Before login, only enable Google if *local* consent exists (prevents confusion).
    if (hasValidStoredConsent()) {
      tncCheck.checked = true;
      setGoogleEnabled(true);
      hideMsg();
    } else {
      tncCheck.checked = false;
      setGoogleEnabled(false);
    }
  })();

  // ===== Checkbox: tick / untick =====
  tncCheck.addEventListener('change', async () => {
    // UNTICK → try to revoke if logged in; otherwise just clear local
    if (!tncCheck.checked) {
      setGoogleEnabled(false);
      clearConsentLocally();
      hideMsg();
      try {
        if (getToken()) await revokeConsent();
      } catch (e) {
        console.warn("Revoke skipped/failed:", e);
      }
      return;
    }

    // TICK → record consent
    setGoogleEnabled(false);
    // If logged-in, send with token so it’s attached to the account
    const withAuth = !!getToken();
    showMsg("Recording your consent…", "#f0ad4e");

    try {
      await postConsent({ withAuth });
      saveConsentLocally(CONSENT_VERSION);
      hideMsg();
      // If logged-in, go straight to app; if not, just enable Google button
      if (withAuth) {
        window.location.href = "/G-CS-Guardian/web.html";
      } else {
        setGoogleEnabled(true);
      }
    } catch (e) {
      console.warn("Consent POST failed:", e);
      tncCheck.checked = false;
      clearConsentLocally();
      setGoogleEnabled(false);
      showMsg("Could not record consent. Please try again.", "#d9534f");
    }
  });

  // Block Google button until consent recorded (either local pre-login or server-confirmed after login)
  googleLink.addEventListener('click', function (e) {
    if (googleLink.classList.contains('disabled')) {
      e.preventDefault();
      showMsg("Please agree to the Terms & Conditions to continue.", "#d9534f");
      tncCheck.focus();
    }
  });

  // ===== OAuth redirect handling =====
  const urlParams = new URLSearchParams(window.location.search);
  const token  = urlParams.get("token");
  const email  = urlParams.get("email");
  const role   = urlParams.get("role");

  // If OAuth just returned, store token & **verify consent on server** before leaving this page.
  (async function handleOAuthReturn() {
    if (!token) return;
    localStorage.setItem("access_token", token);
    if (email) localStorage.setItem("email", email);
    if (role)  localStorage.setItem("role", role);

    // Make Google button irrelevant now; we have a token.
    setGoogleEnabled(false);

    // Ensure backend consent is valid for this version before proceeding
    await ensureConsentAfterAuth();
  })();

  // ===== Admin email/password login =====
  document.getElementById("loginForm").addEventListener("submit", function (event) {
    event.preventDefault();
    login();
  });

  function login() {
    const emailVal = document.getElementById("email").value.trim();
    const passwordVal = document.getElementById("password").value;

    fetch(API_BASE + "/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: emailVal, password: passwordVal }),
    })
    .then((res) => {
      if (!res.ok) throw new Error("Login failed");
      return res.json();
    })
    .then(async (data) => {
      if (data.access_token) {
        localStorage.setItem("access_token", data.access_token);
        if (data.email) localStorage.setItem("email", data.email);
        if (data.role)  localStorage.setItem("role", data.role);

        // After admin login, verify consent on the server first
        await ensureConsentAfterAuth();
      } else {
        const el = document.getElementById("error");
        el.textContent = "Invalid email or password.";
        el.style.display = "block";
      }
    })
    .catch((err) => {
      console.error("Login Error:", err);
      const el = document.getElementById("error");
      el.textContent = "Something went wrong. Try again.";
      el.style.display = "block";
    });
  }
  </script>

</body>
</html>
