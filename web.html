<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G-CS Guardian Website</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="web.css">
  <style>
    /* ===== RESULTS (scan + my-scan) ===== */
    .results-container { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
    .result-card { background: #111; padding: 1rem; border-radius: 8px; color: #eee; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .result-card h3, .result-card h4 { color: #0ff; margin-bottom: 0.5rem; }

    /* ===== Toggle ===== */
    .toggle { display: flex; align-items: center; gap: 10px; }
    /* Keep input focusable but invisible for better click support */
    .toggle input { position:absolute; opacity:0; width:0; height:0; }
    .slider { width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; }
    .slider::before { content: ""; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    .toggle input:checked + .slider::before { transform: translateX(20px); }
    .toggle input:checked + .slider { background: #0ff; }
    .toggle input:disabled + .slider { background:#666; cursor:not-allowed; }
    .toggle-label { color: white; }

    /* ===== Dashboard table (used for Results + Detailed Scan) ===== */
    .table-tools { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .table-tools input[type="text"]{ padding:.5rem .6rem; border:none; border-radius:6px; background:#1a1a1a; color:#eee; }
    .table-tools .chip { background:#1a1a1a; color:#ccc; padding:.35rem .6rem; border-radius:999px; font-size:.85rem; }
    .dashboard-table { width: 100%; border-collapse: collapse; background: #111; color: #eee; margin-top: .75rem; border-radius: 10px; overflow: hidden; }
    .dashboard-table th, .dashboard-table td { padding: 0.8rem 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.08); text-align: left; vertical-align: top; }
    .dashboard-table th { background-color: #0ff; color: #111; position: relative; user-select:none; cursor:pointer; }
    .dashboard-table th .sort-ind { position:absolute; right:.6rem; opacity:.7; }
    .dashboard-table tr:hover { background: rgba(255,255,255,0.05); }

    /* Badges */
    .badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; }
    .badge-public { background:rgb(255, 0, 0); color:#000000; }
    .badge-private { background:#00ff00; color:#000000; }
    .risk-low { background:#204d2a; color:#000000; }
    .risk-medium { background:#4d3a20; color:#000000; }
    .risk-high { background:#5a2525; color:#000000; }
    .risk-critical { background:#6b1a1a; color:#000000; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .nowrap { white-space: nowrap; }

    /* ===== My-Scan ===== */
    .myscan-feature { margin-top: 2rem; }
    .scan-table { width: 100%; border-collapse: collapse; background: #111; color: #eee; margin-top: 1rem; border-radius: 8px; overflow: hidden; }
    .scan-table th, .scan-table td { padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
    .scan-table th { background-color: #0ff; color: #111; }
    .scan-table tr:hover { background: rgba(255,255,255,0.05); }
    .scan-id { cursor: pointer; color: #0ff; text-decoration: underline; }
    .scan-id:hover { color: #00cccc; }
    .myscan-divider { margin: 2rem 0; border: none; height: 1px; background: rgba(255,255,255,0.2); }
    .detailed-scan-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .detailed-scan-form input { flex: 1; padding: 0.5rem; border-radius: 4px; border: none; }
    .detailed-scan-form button { background: #0ff; color: #111; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    .detailed-scan-form button:hover { background: #00cccc; }

    /* ===== HISTORY ===== */
    .history .table-container { overflow-x: auto; margin-top: 20px; }
    .history table { width: 100%; border-collapse: collapse; background-color: #1e1e2f; color: white; border-radius: 8px; overflow: hidden; }
    .history th, .history td { padding: 12px 15px; border-bottom: 1px solid #333; text-align: left; }
    .history th { background-color: #0ff; color: #000; font-weight: bold; }
    .history tr:nth-child(even) { background-color: #2a2a3d; }
    .history tr:hover { background-color: #33334d; transition: 0.2s; }
  </style>
</head>

<body>

  <video autoplay muted loop playsinline id="bg-video">
    <source src="vid11.mp4" type="video/mp4">
    Your browser does not support HTML5 video.
  </video>

  <nav class="navbar" id="navbar">
    <a href="#demo" class="navbar-brand">G-CS Guardian</a>
    <div class="hamburger-menu" id="hamburgerMenu" aria-label="Open menu" role="button" tabindex="0">
      <i class="fas fa-bars"></i>
    </div>
    <ul class="nav-links" id="navLinks" aria-label="Primary">
      <li><a href="#demo" onclick="closeMenu()">Demo</a></li>
      <li><a href="#scanner" onclick="closeMenu()">Scanner</a></li>
      <li><a href="#results" onclick="closeMenu()">Results</a></li>
      <li><a href="#myscan" onclick="closeMenu()">My-Scan</a></li>
      <li><a href="#history" onclick="closeMenu()">History</a></li>
      <li><a href="#aboutus" onclick="closeMenu()">About Us</a></li>
    </ul>
  </nav>

  <!-- DEMO SECTION -->
  <section class="content-section demo" id="demo">
    <div class="container">
      <h2 class="section-title">Watch the Demo</h2>
      <p class="section-content">See how our tool scans your Google Cloud Storage buckets...</p>
      <div class="video-wrapper">
        <video controls>
          <source src="vid3.mp4" type="video/mp4">
        </video>
      </div>
    </div>
  </section>

  <!-- SCAN SECTION -->
  <section class="content-section scan" id="scanner">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>

    <div class="container">
      <h2 class="section-title">Welcome to G-CS Guardian Scanner</h2>
      <p class="section-content">Need a Quick Scan of Your Cloud Storage Bucket? I‚Äôm ready!</p>

      <div class="form">
        <form id="scanForm">
          <label class="toggle" id="ethicalModeLabel">
            <input type="checkbox" id="ethicalModeToggle" aria-label="Ethical Mode (Project Owner Only)">
            <span class="slider"></span>
            <span class="toggle-label">Ethical Mode (Project Owner Only)</span>
          </label>
          <h1 class="form-title">Upload Google Cloud Project ID</h1>
          <div class="card1">
            <div class="terminal">
              <div class="terminal-header">
                <span class="terminal-title">
                  <svg class="terminal-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 17l6-6-6-6M12 19h8"></path>
                  </svg>
                  Terminal
                </span>
              </div>
              <div class="terminal-body">
                <div class="command-line">
                  <span class="prompt">Project ID:</span>
                  <div class="input-wrapper">
                    <input type="text" class="input-field" id="projectId" placeholder="E.g.: g-cs-guardian" required/>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <br/>
          <button id="learn-more" type="button" class="learn-more">Upload & Scan</button>
        </form>
      </div>
    </div>

    <div class="scroll-down" onclick="scrollToSection('results')" aria-label="Scroll to next section">
    </div>
  </section>

  <!-- RESULTS SECTION -->
  <section class="content-section results" id="results">
    <div class="container">
      <h2 class="section-title">Your Scan is Complete!</h2>
      <p class="section-content">This report provides detailed insights into the configuration status of your scanned Google Cloud Storage buckets.</p>

      <!-- scan summary goes here -->
      <div id="results-summary" class="results-container"></div>

      <!-- tools + table -->
      <div class="table-tools" id="results-tools" style="display:none;">
        <input type="text" id="results-filter" placeholder="Filter buckets (name, reason, keyword)..." aria-label="Filter buckets">
        <span class="chip" id="results-count">0 buckets</span>
      </div>
      <table class="dashboard-table" id="results-table" style="display:none;">
        <thead>
          <tr>
            <th data-key="bucket_name">Bucket<span class="sort-ind">‚Üï</span></th>
            <th data-key="public" class="nowrap">Public<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_score" class="nowrap">Risk Score<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_level" class="nowrap">Risk Level<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_reason">Risk Reason<span class="sort-ind">‚Üï</span></th>
            <th data-key="sensitive_keywords_detected">Sensitive Keywords<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_reference">References<span class="sort-ind">‚Üï</span></th>
            <th data-key="sample_files" class="sample-col" style="display:none;">Sample Files<span class="sort-ind">‚Üï</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- MY-SCAN SECTION -->
  <section class="content-section myscan" id="myscan">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>

    <div class="container">
      <h2 class="section-title">My-Scan</h2>
      <p class="section-content">My-Scan lets you review past scans without rescanning the same project.</p>

      <!-- Feature 1: Previous Scan -->
      <div class="myscan-feature">
        <h3>Previous Scans</h3>
        <p>View all your previous scans with timestamps and IDs.</p>
        <table class="scan-table">
          <thead>
            <tr><th>Timestamp</th><th>Scan ID</th><th>Project ID</th></tr>
          </thead>
          <tbody id="previous-scan-table">
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <hr class="myscan-divider">

      <!-- Feature 2: Detailed Scan Results -->
      <div class="myscan-feature">
        <h3>Detailed Scan Results</h3>
        <p>Enter a Scan ID to retrieve detailed scan information.</p>
        <div class="detailed-scan-form">
          <input type="text" id="scanIdInput" placeholder="Enter Scan ID" aria-label="Enter Scan ID">
          <button onclick="fetchDetailedScan()" aria-label="Fetch scan details">Enter</button>
        </div>

        <!-- summary -->
        <div id="detailed-scan-results" class="results-container" style="margin-top:1rem;"></div>

        <!-- tools + table -->
        <div class="table-tools" id="detailed-tools" style="display:none;">
          <input type="text" id="detailed-filter" placeholder="Filter buckets (name, reason, keyword)..." aria-label="Filter buckets">
          <span class="chip" id="detailed-count">0 buckets</span>
        </div>
        <table class="dashboard-table" id="detailed-table" style="display:none;">
          <thead>
            <tr>
              <th data-key="bucket_name">Bucket Name<span class="sort-ind">‚Üï</span></th>
              <th data-key="public" class="nowrap">Bucket Status<span class="sort-ind">‚Üï</span></th>
              <th data-key="exposure_reason" class="nowrap">Exposure Reason<span class="sort-ind">‚Üï</span></th>
              <th data-key="risk_score" class="nowrap">Risk Score<span class="sort-ind">‚Üï</span></th>
              <th data-key="risk_reason">Risk Reason<span class="sort-ind">‚Üï</span></th>
              <th data-key="sensitive_keywords_detected">Sensitive Keywords<span class="sort-ind">‚Üï</span></th>
              <th data-key="risk_reference">Risk Score References<span class="sort-ind">‚Üï</span></th>
              <th data-key="sample_files" class="sample-col" style="display:none;">Sample Files<span class="sort-ind">‚Üï</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HISTORY SECTION (owner only) -->
  <section class="content-section history" id="history">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>
    <div class="container">
      <h2 class="section-title">History</h2>
      <p class="section-content">This section is only visible to the project owner.</p>
      <div class="table-container">
        <table id="historyTable">
          <thead>
            <tr><th>Scan ID</th><th>Project ID</th><th>User Email</th><th>Timestamp</th><th>Result Summary</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="5" style="text-align:center;">Loading history...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ABOUT US SECTION -->
<section class="content-section aboutus" id="aboutus">
  <div class="faq-content">
    <h2 class="section-title">Meet the Minds Behind It All</h2>
    <p class="section-content">Back-End Brains & Front-End Flair</p>
    <div class="team-slider">
      <div class="team-card">
        <div class="card-inner">
          <div class="card-front" style="background-image:url('siramir.jpg');background-size:cover;">
            <div class="overlay"><h3>Supervisor</h3><p>Sir Amir Hakeem Bin Sahrir</p></div>
          </div>
          <div class="card-back"><p>"Forever Sensei and Mentor"</p></div>
        </div>
      </div>
      <div class="team-card">
        <div class="card-inner">
          <div class="card-front" style="background-image:url('');background-size:cover;">
            <div class="overlay"><h3>Coming soon</h3><p>Miss Adani Binti</p></div>
          </div>
          <div class="card-back"><p>"Coming Soon"</p></div>
        </div>
      </div>
      <div class="team-card">
        <div class="card-inner">
          <div class="card-front" style="background-image:url('aqil.jpg');background-size:cover;">
            <div class="overlay"><h3>Group Leader</h3><p>Muhammad Aqil Darwisy Bin Nor Azli</p></div>
          </div>
          <div class="card-back"><p>"Failure Is Just a Temporary Syntax Error"</p></div>
        </div>
      </div>
      <div class="team-card">
        <div class="card-inner">
          <div class="card-front" style="background-image:url('ilhan.jpg');background-size:cover;">
            <div class="overlay"><h3>Group Member</h3><p>Ilhan Munsieff Bin Abdullah</p></div>
          </div>
          <div class="card-back"><p>"The best defense against cyber threats is a well-educated mind"</p></div>
        </div>
      </div>
      <div class="team-card">
        <div class="card-inner">
          <div class="card-front" style="background-image:url('jib.jpg');background-size:cover;">
            <div class="overlay"><h3>Group Member</h3><p>Jibril Ruhul Amin Bin Mohd Nor Ariffin</p></div>
          </div>
          <div class="card-back"><p>"In a world full of threats, be the shield"</p></div>
        </div>
      </div>
    </div>
  </div>
</section>


  <!-- SCRIPTS (inline bootstrapping) -->
  <script>
    // ====== Simple helpers ======
    function scrollToSection(id) {
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: "smooth" });
    }
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return isNaN(date.getTime()) ? "N/A" : date.toLocaleString();
    }
    function getToken() { return localStorage.getItem("access_token"); }

    // risk helpers
    function riskLevelFromScore(score) {
      const s = Number(score ?? 0);
      if (s >= 80) return "Critical";
      if (s >= 60) return "High";
      if (s >= 40) return "Medium";
      return "Low";
    }
    function riskClass(level) {
      switch ((level || "").toLowerCase()) {
        case "critical": return "risk-critical";
        case "high": return "risk-high";
        case "medium": return "risk-medium";
        default: return "risk-low";
      }
    }

    // ====== Mobile nav ======
    const navLinks = document.getElementById("navLinks");
    const hamburgerMenu = document.getElementById("hamburgerMenu");
    function closeMenu() { navLinks?.classList.remove("open"); }
    hamburgerMenu?.addEventListener("click", () => navLinks?.classList.toggle("open"));
    hamburgerMenu?.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") navLinks?.classList.toggle("open"); });

    // ====== Auth guard ======
    (function authGuard() {
      const token = getToken();
      if (!token) window.location.href = "signup.html";
    })();

    // Normalize possible role strings coming from backend/UI storage
    function normalizeRole(r) {
      const s = String(r || "").trim().toLowerCase();
      if (["project_owner", "project owner", "owner"].includes(s)) return "project_owner";
      if (["creator"].includes(s)) return "creator";
      if (["regular", "user"].includes(s)) return "regular";
      return s || "regular";
    }

    /* ============================================================
       ETHICAL TOGGLE LOGIC ‚Äî ONLY THIS PART CHANGED
       - Toggle is enabled ONLY if:
         (a) user is Owner/Creator, AND
         (b) Project ID field is non-empty.
       - If Project ID becomes empty, toggle auto-turns OFF and disables.
       - Titles reflect why it‚Äôs disabled.
    ============================================================ */
    (function roleGate() {
      const rawRole = localStorage.getItem("role");
      const role = normalizeRole(rawRole);

      const ethicalToggle = document.getElementById("ethicalModeToggle");
      const historySection = document.getElementById("history");
      const projectInput  = document.getElementById("projectId");

      const isOwner = role === "project_owner" || role === "creator";

      function updateEthicalToggleState() {
        const hasProjectId = !!(projectInput && projectInput.value.trim());
        const canUse = isOwner && hasProjectId;

        if (ethicalToggle) {
          if (!canUse) {
            ethicalToggle.checked = false;     // force OFF when not allowed
          }
          ethicalToggle.disabled = !canUse;
          ethicalToggle.title = isOwner
            ? (hasProjectId ? "Ethical Mode is available" : "Enter a Project ID to enable Ethical Mode")
            : "Only project owners can enable Ethical Mode";
        }
      }

      // initial state
      updateEthicalToggleState();

      // respond to typing/changes in Project ID
      projectInput?.addEventListener("input", updateEthicalToggleState);

      // hide History for non-owners (unchanged)
      if (historySection && !isOwner) {
        historySection.style.display = "none";
      }
    })();
    /* ========================= END CHANGE ========================= */

    // ====== Generic table renderer (reusable) ======
    function renderResultsTable(options) {
      const {
        buckets, ethicalMode,
        tableEl, toolsEl, countEl, filterInput,
        defaultSortKey = "risk_score", defaultSortDir = "desc"
      } = options;

      // toggle sample files column
      tableEl.querySelectorAll(".sample-col").forEach(th => th.style.display = ethicalMode ? "" : "none");

      // internal state
      let rows = Array.isArray(buckets) ? [...buckets] : [];
      let sortKey = defaultSortKey;
      let sortDir = defaultSortDir; // 'asc' | 'desc'

      const tbody = tableEl.querySelector("tbody");
      const thead = tableEl.querySelector("thead");

      function normalizedText(v) {
        if (v == null) return "";
        return String(v).toLowerCase();
      }

      function applyFilter() {
        const q = normalizedText(filterInput?.value || "");
        return rows.filter(b => {
          const name = normalizedText(b.bucket_name);
          const reason = normalizedText(b.risk_reason);
          const kws = Array.isArray(b.sensitive_keywords_detected)
            ? normalizedText(b.sensitive_keywords_detected.join(","))
            : normalizedText(b.sensitive_keywords_detected);

          return !q || name.includes(q) || reason.includes(q) || kws.includes(q);
        });
      }

      function sortData(arr) {
        const dir = sortDir === "asc" ? 1 : -1;
        return arr.sort((a, b) => {
          const va = (sortKey === "risk_level") ? riskLevelFromScore(a.risk_score) : a[sortKey];
          const vb = (sortKey === "risk_level") ? riskLevelFromScore(b.risk_score) : b[sortKey];

          if (sortKey === "risk_score") {
            return (Number(va||0) - Number(vb||0)) * dir;
          }
          if (sortKey === "public") {
            return ((va === true ? 1 : 0) - (vb === true ? 1 : 0)) * dir;
          }
          const sa = String(va ?? "").toLowerCase();
          const sb = String(vb ?? "").toLowerCase();
          if (sa < sb) return -1 * dir;
          if (sa > sb) return 1 * dir;
          return 0;
        });
      }

      function linkifyRefs(refs) {
        if (!refs) return "N/A";
        const arr = Array.isArray(refs) ? refs : [refs];
        return arr.map((u, i) => `<a href="${u}" target="_blank" rel="noopener">Ref ${i+1}</a>`).join(", ");
      }

      function render() {
        const filtered = sortData(applyFilter());
        tbody.innerHTML = "";
        filtered.forEach(b => {
          const level = riskLevelFromScore(b.risk_score);
          const sens = Array.isArray(b.sensitive_keywords_detected)
            ? b.sensitive_keywords_detected.join(", ")
            : (b.sensitive_keywords_detected ?? "None");
          const samples = ethicalMode && b.sample_files
            ? (Array.isArray(b.sample_files) ? b.sample_files.join(", ") : b.sample_files)
            : "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${b.bucket_name ?? "Unknown"}</td>
            <td class="nowrap">
              ${b.public ? '<span class="badge badge-public">Public</span>' : '<span class="badge badge-private">Private</span>'}
            </td>
            <td class="nowrap mono">${b.risk_score ?? "0"}</td>
            <td class="nowrap"><span class="badge ${riskClass(level)}">${level}</span></td>
            <td>${b.risk_reason ?? "N/A"}</td>
            <td>${sens}</td>
            <td>${linkifyRefs(b.risk_reference)}</td>
            <td class="sample-col" style="${ethicalMode ? "" : "display:none;"}">${samples || ""}</td>
          `;
          tbody.appendChild(tr);
        });
        if (toolsEl) toolsEl.style.display = "flex";
        if (tableEl) tableEl.style.display = "table";
        if (countEl) countEl.textContent = `${filtered.length} bucket${filtered.length===1?"":"s"}`;
        updateHeaderIndicators();
      }

      function updateHeaderIndicators() {
        thead.querySelectorAll("th").forEach(th => {
          const ind = th.querySelector(".sort-ind");
          if (!ind) return;
          const key = th.getAttribute("data-key");
          if (key === sortKey) {
            ind.textContent = sortDir === "asc" ? "‚Üë" : "‚Üì";
          } else {
            ind.textContent = "‚Üï";
          }
        });
      }

      // events
      thead.querySelectorAll("th[data-key]").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (key === sortKey) {
            sortDir = (sortDir === "asc") ? "desc" : "asc";
          } else {
            sortKey = key;
            sortDir = (key === "risk_score") ? "desc" : "asc";
          }
          render();
        });
      });
      filterInput?.addEventListener("input", () => render());

      // initial render (risk score high ‚Üí low)
      render();
    }

    // ====== RESULTS (live scan) ======
    async function runScan(projectId, ethicalMode) {
      const token = getToken();
      const resultsSummary = document.getElementById("results-summary");
      const resultsTools = document.getElementById("results-tools");
      const resultsTable = document.getElementById("results-table");
      const resultsFilter = document.getElementById("results-filter");
      const resultsCount = document.getElementById("results-count");

      resultsSummary.innerHTML = `<p>üîç Scanning in progress...</p>`;
      resultsTools.style.display = "none";
      resultsTable.style.display = "none";

      const apiUrl = `https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/scan?project_id=${encodeURIComponent(projectId)}&ethical_mode=${ethicalMode}`;

      const response = await fetch(apiUrl, {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!response.ok) {
        let msg = `Scan failed: ${response.status}`;
        try {
          const err = await response.json();
          if (err && err.detail) msg = Array.isArray(err.detail) ? err.detail.map(d => d.msg).join(", ") : err.detail;
        } catch {}
        throw new Error(msg);
      }

      const apiData = await response.json();
      const { scan_id, project_role, buckets } = apiData;

      resultsSummary.innerHTML = `
        <div class="result-card">
          <h3>Scan Summary</h3>
          <p><strong>Scan ID:</strong> ${scan_id}</p>
          <p><strong>Detected Role:</strong> ${project_role || "N/A"}</p>
          <p><strong>Bucket Count:</strong> ${Array.isArray(buckets) ? buckets.length : 0}</p>
        </div>
      `;

      renderResultsTable({
        buckets: Array.isArray(buckets) ? buckets : [],
        ethicalMode,
        tableEl: resultsTable,
        toolsEl: resultsTools,
        countEl: resultsCount,
        filterInput: resultsFilter,
        defaultSortKey: "risk_score",
        defaultSortDir: "desc"
      });

      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // ====== Scanner button ======
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("learn-more").addEventListener("click", async function () {
        const ethicalMode = document.getElementById("ethicalModeToggle").checked;
        const projectId = document.getElementById("projectId").value.trim();
        if (!projectId) { alert("Please enter a Project ID."); return; }

        try {
          const token = getToken();
          if (!token) { alert("You are not logged in."); return; }
          await runScan(projectId, ethicalMode);
        } catch (error) {
          document.getElementById("results-summary").innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
        }
      });
    });

    // ====== My-Scan APIs ======
    const API_PREVIOUS_SCANS = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/my-scans/";
    const API_SCAN_DETAILS = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/my-scans/{scan_id}";

    async function loadPreviousScans() {
      const tableBody = document.getElementById("previous-scan-table");
      tableBody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

      const token = getToken();
      if (!token) {
        tableBody.innerHTML = "<tr><td colspan='3'>Please log in to view scans</td></tr>";
        return;
      }

      try {
        const res = await fetch(API_PREVIOUS_SCANS, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Failed to fetch scans (${res.status})`);
        const data = await res.json();
        const scans = Array.isArray(data?.my_scans) ? data.my_scans : [];

        if (scans.length === 0) {
          tableBody.innerHTML = "<tr><td colspan='3'>No scans found</td></tr>";
          return;
        }

        tableBody.innerHTML = "";
        scans.forEach(scan => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatDate(scan.timestamp)}</td>
            <td class="scan-id" aria-label="Click to view details">${scan.scan_id || "N/A"}</td>
            <td>${scan.project_id || "N/A"}</td>
          `;
          row.querySelector(".scan-id").addEventListener("click", () => {
            document.getElementById("scanIdInput").value = scan.scan_id;
            fetchDetailedScan();
          });
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error(error);
        tableBody.innerHTML = `<tr><td colspan='3'>Error: ${error.message}</td></tr>`;
      }
    }

    async function fetchDetailedScan() {
      const scanId = document.getElementById("scanIdInput").value.trim();
      const resultsContainer = document.getElementById("detailed-scan-results");
      const tableEl = document.getElementById("detailed-table");
      const toolsEl = document.getElementById("detailed-tools");
      const filterEl = document.getElementById("detailed-filter");
      const countEl = document.getElementById("detailed-count");

      resultsContainer.innerHTML = "<p>Loading...</p>";
      toolsEl.style.display = "none";
      tableEl.style.display = "none";

      if (!scanId) { resultsContainer.innerHTML = "<p>Please enter a Scan ID.</p>"; return; }

      const token = getToken();
      try {
        const res = await fetch(API_SCAN_DETAILS.replace("{scan_id}", encodeURIComponent(scanId)), {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
          let msg = `Scan not found (${res.status})`;
          try {
            const err = await res.json();
            if (err && err.detail) msg = Array.isArray(err.detail) ? err.detail.map(d => d.msg).join(", ") : err.detail;
          } catch {}
          throw new Error(msg);
        }

        const data = await res.json();
        const buckets = Array.isArray(data?.buckets) ? data.buckets : [];
        const ethicalMode = Boolean(data?.ethical_mode);

        // Header summary
        resultsContainer.innerHTML = `
          <div class="result-card">
            <h4>Scan ${data.scan_id}</h4>
            <p><strong>Project:</strong> ${data.project_id || "N/A"}</p>
            <p><strong>Time:</strong> ${formatDate(data.timestamp)}</p>
            <p><strong>Role:</strong> ${data.project_role || "N/A"} | <strong>Ethical Mode:</strong> ${ethicalMode ? "On" : "Off"}</p>
            <p><strong>Bucket Count:</strong> ${buckets.length}</p>
          </div>
        `;

        if (buckets.length === 0) {
          resultsContainer.insertAdjacentHTML("beforeend", "<p>No bucket results stored for this scan.</p>");
          return;
        }

        renderResultsTable({
          buckets,
          ethicalMode,
          tableEl,
          toolsEl,
          countEl,
          filterInput: filterEl,
          defaultSortKey: "risk_score",
          defaultSortDir: "desc"
        });
      } catch (error) {
        console.error(error);
        resultsContainer.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", loadPreviousScans);

    // ====== History fetch (owner only) ======
    document.addEventListener("DOMContentLoaded", function () {
      const role = normalizeRole(localStorage.getItem("role"));
      const isOwner = role === "project_owner" || role === "creator";
      if (!isOwner) return;

      const historyTableBody = document.querySelector("#historyTable tbody");
      const apiURL = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/history";
      const token = getToken();
      if (!token) {
        historyTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Please log in to view history</td></tr>`;
        return;
      }

      fetch(apiURL, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }
      })
      .then(r => r.ok ? r.json() : Promise.reject(new Error(`Failed (${r.status})`)))
      .then(data => {
        historyTableBody.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          historyTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No history found</td></tr>`;
          return;
        }
        data.forEach(item => {
          historyTableBody.innerHTML += `
            <tr>
              <td>${item.scan_id}</td>
              <td>${item.project_id}</td>
              <td>${item.user_email}</td>
              <td>${formatDate(item.timestamp)}</td>
              <td>${item.result_summary}</td>
            </tr>
          `;
        });
      })
      .catch(error => {
        console.error("Error fetching history:", error);
        historyTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error loading history</td></tr>`;
      });
    });

    // ====== Optional: show stored email/role if such elements exist ======
    document.addEventListener("DOMContentLoaded", () => {
      const emailElement = document.getElementById("user-email");
      const roleElement = document.getElementById("user-role");
      const userEmail = localStorage.getItem("email");
      const userRole = localStorage.getItem("role");
      if (emailElement) emailElement.textContent = userEmail || "Unknown";
      if (roleElement) roleElement.textContent = userRole || "Unknown";
    });
  </script>

  <!-- Your existing JS if needed -->
  <script src="web.js"></script>
</body>
</html>
