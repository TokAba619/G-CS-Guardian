<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G-CS Guardian Tool</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- your global scanner CSS (already defines --cyan); ensure it sets --cyan: #E91E63 -->
  <link rel="stylesheet" href="web.css">
  <style>
    /* Ensure theme color is pink everywhere on this page */
    :root { --cyan: #E91E63; --accent:#E91E63; }

    /* ===== RESULTS (scan + my-scan) ===== */
    .results-container { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
    .result-card { background: #111; padding: 1rem; border-radius: 8px; color: #eee; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .result-card h3, .result-card h4 { color: var(--cyan); margin-bottom: 0.5rem; }

    /* ===== Toggle ===== */
    .toggle { display: flex; align-items: center; gap: 10px; }
    .toggle input { position:absolute; opacity:0; width:0; height:0; }
    .slider { width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; }
    .slider::before { content: ""; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    .toggle input:checked + .slider::before { transform: translateX(20px); }
    .toggle input:checked + .slider { background: var(--cyan); }
    .toggle input:disabled + .slider { background:#666; cursor:not-allowed; }
    .toggle-label { color: white; }

    /* ===== Navbar brand with logo (match your top header look) ===== */
    .navbar-brand {
      display: flex; align-items: center; gap: 12px;
      color: var(--cyan); font-size: 1.8rem; font-weight: 800; text-decoration: none; letter-spacing: 1px;
      text-shadow: 1px 1px 3px #000;
    }
    .navbar-brand .brand-logo {
      width: 34px; height: 34px; border-radius: 6px; object-fit: contain; display: block;
      background: transparent;
    }

    /* ===== Nav links underline / hover color to pink ===== */
    .nav-links a { color:#fff; text-decoration:none; font-size:1.1rem; font-weight:600; padding:5px 0; position:relative; transition:color .3s; }
    .nav-links a::after {
      content:''; position:absolute; width:0; height:2px; background: var(--cyan); left:0; bottom:0; transition:width .3s ease;
    }
    .nav-links a:hover::after, .nav-links a.active::after { width:100%; }
    .nav-links a:hover { color: var(--cyan); }

    /* ===== Dashboard table ===== */
    .table-tools { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .table-tools input[type="text"]{ padding:.5rem .6rem; border:none; border-radius:6px; background:#1a1a1a; color:#eee; }
    .table-tools .chip { background:#1a1a1a; color:#ccc; padding:.35rem .6rem; border-radius:999px; font-size:.85rem; }

    .dashboard-table { width: 100%; border-collapse: collapse; background: #111; color: #eee; margin-top: .75rem; border-radius: 10px; overflow: hidden; }
    .dashboard-table th, .dashboard-table td { padding: 0.8rem 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.08); text-align: left; vertical-align: top; }
    .dashboard-table th { background-color: var(--cyan); color: #111; position: relative; user-select:none; cursor:pointer; }
    .dashboard-table th .sort-ind { position:absolute; right:.6rem; opacity:.7; }
    .dashboard-table tr:hover { background: rgba(255,255,255,0.05); }

    /* Badges */
    .badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; }
    .badge-public { background:rgb(255, 0, 0); color:#000000; }
    .badge-private { background:#00ff00; color:#000000; }
    .risk-low { background:#00ff37; color:#000000; }
    .risk-medium { background:#ffee00; color:#000000; }
    .risk-high { background:#7a0c0c; color:#000000; }
    .risk-critical { background:#ff0000; color:#000000; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .nowrap { white-space: nowrap; }

    /* ===== Sample Files column (toggle on) ===== */
    .sample-col { width: 320px; }
    .sample-list { margin: 0; padding: 0; list-style: none; display: flex; flex-direction: column; gap: .35rem; }
    .sample-link {
      display: inline-block;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--cyan);
      text-decoration: underline;
    }
    .sample-link:hover { color: #c2185b; }

    /* ===== My-Scan ===== */
    .myscan-feature { margin-top: 2rem; }
    .scan-table { width: 100%; border-collapse: collapse; background: #111; color: #eee; margin-top: 1rem; border-radius: 8px; overflow: hidden; }
    .scan-table th, .scan-table td { padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
    .scan-table th { background-color: var(--cyan); color: #111; }
    .scan-table tr:hover { background: rgba(255,255,255,0.05); }
    .scan-id { cursor: pointer; color: var(--cyan); text-decoration: underline; }
    .scan-id:hover { color: #c2185b; }
    .myscan-divider { margin: 2rem 0; border: none; height: 1px; background: rgba(255,255,255,0.2); }

    .detailed-scan-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .detailed-scan-form input { flex: 1; padding: 0.5rem; border-radius: 4px; border: none; }
    .detailed-scan-form button { background: var(--cyan); color: #111; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    .detailed-scan-form button:hover { background: #c2185b; color:#fff; }

    /* ===== HISTORY ===== */
    .history .table-container { overflow-x: auto; margin-top: 20px; }
    .history table { width: 100%; border-collapse: collapse; background-color: #1e1e2f; color: white; border-radius: 8px; overflow: hidden; }
    .history th, .history td { padding: 12px 15px; border-bottom: 1px solid #333; text-align: left; }
    .history th { background-color: var(--cyan); color: #000; font-weight: bold; }
    .history tr:nth-child(even) { background-color: #2a2a3d; }
    .history tr:hover { background-color: #33334d; transition: 0.2s; }

    /* ===== NEW: minimal pill input + CTA for scanner ===== */
    .inline-form {
      display:flex; gap:12px; align-items:center; justify-content:center;
      max-width: 720px; margin: 18px auto 0;
      padding: 6px;
    }
    .pill-input {
      flex: 1;
      height: 52px;
      padding: 0 18px;
      border-radius: 999px;
      border: 1.5px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.35);
      color: #fff;
      outline: none;
      font-size: 16px;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    .pill-input::placeholder { color: rgba(255,255,255,.70); }
    .pill-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(233,30,99,.16);
      background: rgba(0,0,0,.45);
    }
    .cta-pink {
      height: 52px;
      padding: 0 22px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 800;
      letter-spacing: .2px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform .06s ease, box-shadow .2s ease, background .15s ease;
      box-shadow: 0 8px 24px rgba(233,30,99,.28);
    }
    .cta-pink:hover { background: #d81b60; box-shadow: 0 10px 28px rgba(233,30,99,.34); }
    .cta-pink:active { transform: translateY(1px); box-shadow: 0 6px 20px rgba(233,30,99,.28); }
    .form-title { font-size: 28px; font-weight: 800; text-align: center; margin-top: 18px; margin-bottom: 4px; }
    .toggle { justify-content: center; margin: 10px auto 0; }
    .scan .input-slab { margin-top: 8px; }
    @media (max-width: 640px){
      .inline-form { flex-direction: column; align-items: stretch; }
      .cta-pink { width: 100%; }
    }
  </style>
</head>

<body>

  <nav class="navbar" id="navbar">
    <!-- Brand with logo (match header concept) -->
    <a href="index.html" class="navbar-brand">
      <img src="logo.png" alt="G-CS Guardian Logo" class="brand-logo">
      <span>G-CS Guardian</span>
    </a>

    <div class="hamburger-menu" id="hamburgerMenu" aria-label="Open menu" role="button" tabindex="0">
      <i class="fas fa-bars"></i>
    </div>
    <ul class="nav-links" id="navLinks" aria-label="Primary">
      <li><a href="#demo" onclick="closeMenu()">Demo</a></li>
      <li><a href="#scanner" onclick="closeMenu()">Scanner</a></li>
      <li><a href="#results" onclick="closeMenu()">Results</a></li>
      <li><a href="#myscan" onclick="closeMenu()">My-Scan</a></li>
      <li><a href="#history" onclick="closeMenu()">History</a></li>
      <li><a href="#aboutus" onclick="closeMenu()">About Us</a></li>
    </ul>
  </nav>

  <!-- DEMO SECTION -->
  <section class="content-section demo" id="demo">
    <div class="container">
      <h2 class="section-title">Watch the Demo</h2>
      <p class="section-content">See how our tool scans your Google Cloud Storage buckets...</p>
      <div class="video-wrapper">
        <video controls>
          <source src="vid3.mp4" type="video/mp4">
        </video>
      </div>
    </div>
  </section>

  <!-- SCAN SECTION -->
  <section class="content-section scan" id="scanner">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>

    <div class="container">
      <h2 class="section-title">Welcome to G-CS Guardian Scanner</h2>
      <p class="section-content">Need a Quick Scan of Your Cloud Storage Bucket? I‚Äôm ready!</p>

      <div class="form">
        <form id="scanForm" class="input-slab">
          <label class="toggle" id="ethicalModeLabel">
            <input type="checkbox" id="ethicalModeToggle" aria-label="Ethical Mode (Project Owner Only)">
            <span class="slider"></span>
            <span class="toggle-label">Full Access Scan (Project Owner)</span>
          </label>

          <h1 class="form-title">Upload Google Cloud Project ID</h1>

          <!-- NEW minimal pill input + CTA -->
          <div class="inline-form" role="group" aria-label="Project scan form">
            <input
              type="text"
              class="pill-input"
              id="projectId"
              placeholder="Your project ID here (e.g. g-cs-guardian)"
              autocomplete="off"
              required
              aria-label="Project ID"
            />
            <button id="learn-more" type="button" class="cta-pink" aria-label="Upload and scan">Upload &amp; Scan</button>
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- RESULTS SECTION -->
  <section class="content-section results" id="results">
    <div class="container">
      <h2 class="section-title">Your Scan is Complete!</h2>
      <p class="section-content">This report provides detailed insights into the configuration status of your scanned Google Cloud Storage buckets.</p>

      <div id="results-summary" class="results-container"></div>

      <div class="table-tools" id="results-tools" style="display:none;">
        <input type="text" id="results-filter" placeholder="Filter buckets (bucket name)..." aria-label="Filter buckets">
        <span class="chip" id="results-count">0 buckets</span>
      </div>
      <table class="dashboard-table" id="results-table" style="display:none;">
        <thead>
          <tr>
            <th data-key="bucket_name">Bucket<span class="sort-ind">‚Üï</span></th>
            <th data-key="public" class="nowrap">Public<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_score" class="nowrap">Risk Score<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_level" class="nowrap">Risk Level<span class="sort-ind">‚Üï</span></th>
            <th data-key="risk_reason">Risk Reason<span class="sort-ind">‚Üï</span></th>
            <th data-key="sensitive_keywords_detected">Sensitive Keywords<span class="sort-ind">‚Üï</span></th>
            <th data-key="sample_files" class="sample-col" style="display:none;">Sample Files<span class="sort-ind">‚Üï</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- MY-SCAN SECTION -->
  <section class="content-section myscan" id="myscan">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>

    <div class="container">
      <h2 class="section-title">My-Scan</h2>
      <p class="section-content">My-Scan lets you review past scans without rescanning the same project.</p>

      <div class="myscan-feature">
        <h3>Previous Scans</h3>
        <p>View all your previous scans with timestamps and IDs.</p>
        <table class="scan-table">
          <thead>
            <tr><th>Timestamp</th><th>Scan ID</th><th>Project ID</th></tr>
          </thead>
          <tbody id="previous-scan-table">
            <tr><td colspan="3">Loading...</td></tr>
          </tbody>
        </table>
      </div>

      <hr class="myscan-divider">

      <div class="myscan-feature">
        <h3>Detailed Scan Results</h3>
        <p>Enter a Scan ID to retrieve detailed scan information.</p>
        <div class="detailed-scan-form">
          <input type="text" id="scanIdInput" placeholder="Enter Scan ID" aria-label="Enter Scan ID">
          <button onclick="fetchDetailedScan()" aria-label="Fetch scan details">Enter</button>
        </div>

        <div id="detailed-scan-results" class="results-container" style="margin-top:1rem;"></div>

        <div class="table-tools" id="detailed-tools" style="display:none;">
          <input type="text" id="detailed-filter" placeholder="Filter buckets (name, reason, keyword)..." aria-label="Filter buckets">
          <span class="chip" id="detailed-count">0 buckets</span>
        </div>
        <table class="dashboard-table" id="detailed-table" style="display:none;">
          <thead>
            <tr>
              <th data-key="bucket_name">Bucket<span class="sort-ind">‚Üï</span></th>
              <th data-key="public" class="nowrap">Public<span class="sort-ind">‚Üï</span></th>
              <th data-key="risk_score" class="nowrap">Risk Score<span class="sort-ind">‚Üï</span></th>
              <th data-key="risk_level" class="nowrap">Risk Level<span class="sort-ind">‚Üï</span></th>
              <th data-key="risk_reason">Risk Reason<span class="sort-ind">‚Üï</span></th>
              <th data-key="sensitive_keywords_detected">Sensitive Keywords<span class="sort-ind">‚Üï</span></th>
              <th data-key="sample_files" class="sample-col" style="display:none;">Sample Files<span class="sort-ind">‚Üï</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HISTORY SECTION (owner only) -->
  <section class="content-section history" id="history">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>
    <div class="container">
      <h2 class="section-title">History</h2>
      <p class="section-content">This section is only visible to the project owner.</p>
      <div class="table-container">
        <table id="historyTable">
          <thead>
            <tr><th>Scan ID</th><th>Project ID</th><th>User Email</th><th>Timestamp</th><th>Result Summary</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="5" style="text-align:center;">Loading history...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ABOUT US SECTION -->
  <section class="content-section aboutus" id="aboutus">
    <div class="faq-content">
      <h2 class="section-title">Meet the Minds Behind It All</h2>
      <p class="section-content">Back-End Brains & Front-End Flair</p>
      <div class="team-slider">
        <div class="team-card">
          <div class="card-inner">
            <div class="card-front" style="background-image:url('siramir.jpg');background-size:cover;">
              <div class="overlay"><h3>Supervisor</h3><p>Sir Amir Hakeem Bin Sahrir</p></div>
            </div>
            <div class="card-back"><p>"Forever Sensei and Mentor"</p></div>
          </div>
        </div>
        <div class="team-card">
          <div class="card-inner">
            <div class="card-front" style="background-image:url('');background-size:cover;">
              <div class="overlay"><h3>Coming soon</h3><p>Miss Adani Binti</p></div>
            </div>
            <div class="card-back"><p>"Coming Soon"</p></div>
          </div>
        </div>
        <div class="team-card">
          <div class="card-inner">
            <div class="card-front" style="background-image:url('aqil.jpg');background-size:cover;">
              <div class="overlay"><h3>Group Leader</h3><p>Muhammad Aqil Darwisy Bin Nor Azli</p></div>
            </div>
            <div class="card-back"><p>"Failure Is Just a Temporary Syntax Error"</p></div>
          </div>
        </div>
        <div class="team-card">
          <div class="card-inner">
            <div class="card-front" style="background-image:url('ilhan.jpg');background-size:cover;">
              <div class="overlay"><h3>Group Member</h3><p>Ilhan Munsieff Bin Abdullah</p></div>
            </div>
            <div class="card-back"><p>"The best defense against cyber threats is a well-educated mind"</p></div>
          </div>
        </div>
        <div class="team-card">
          <div class="card-inner">
            <div class="card-front" style="background-image:url('jib.jpg');background-size:cover;">
              <div class="overlay"><h3>Group Member</h3><p>Jibril Ruhul Amin Bin Mohd Nor Ariffin</p></div>
            </div>
            <div class="card-back"><p>"In a world full of threats, be the shield"</p></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SCRIPTS (inline bootstrapping) -->
  <script>
    // ====== Simple helpers ======
    function scrollToSection(id) {
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: "smooth" });
    }
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return isNaN(date.getTime()) ? "N/A" : date.toLocaleString();
    }
    function getToken() { return localStorage.getItem("access_token"); }

    // ====== Risk helpers: 1‚Äì10 scale ======
    function riskLevelFromScore(score) {
      const s = Number(score ?? 0);
      if (s >= 10) return "Critical"; // 10 only
      if (s >= 7)  return "High";     // 7‚Äì9
      if (s >= 4)  return "Medium";   // 4‚Äì6
      return "Low";                   // 1‚Äì3 (and 0 fallback)
    }
    function riskClass(level) {
      switch ((level || "").toLowerCase()) {
        case "critical": return "risk-critical";
        case "high": return "risk-high";
        case "medium": return "risk-medium";
        default: return "risk-low";
      }
    }

    // ====== Mobile nav ======
    const navLinks = document.getElementById("navLinks");
    const hamburgerMenu = document.getElementById("hamburgerMenu");
    function closeMenu() { navLinks?.classList.remove("open"); }
    hamburgerMenu?.addEventListener("click", () => navLinks?.classList.toggle("open"));
    hamburgerMenu?.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") navLinks?.classList.toggle("open"); });

    // ====== Auth guard ======
    (function authGuard() {
      const token = getToken();
      if (!token) window.location.href = "signup.html";
    })();

    function normalizeRole(r) {
      const s = String(r || "").trim().toLowerCase();
      if (["project_owner", "project owner", "owner"].includes(s)) return "project_owner";
      if (["creator"].includes(s)) return "creator";
      if (["regular", "user"].includes(s)) return "regular";
      return s || "regular";
    }

   /* ============================================================
   ETHICAL TOGGLE LOGIC ‚Äî FINAL
   ============================================================ */
(function roleGate() {
  function parseJwt(token) {
    try {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      const jsonPayload = decodeURIComponent(
        atob(base64).split("").map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)).join("")
      );
      return JSON.parse(jsonPayload);
    } catch { return null; }
  }
  function getToken() { return localStorage.getItem("access_token"); }
  function normalizeRole(r) {
    const s = String(r || "").trim().toLowerCase();
    if (["project_owner", "project owner", "owner"].includes(s)) return "project_owner";
    if (["creator"].includes(s)) return "creator";
    if (["regular", "user", "viewer"].includes(s)) return "regular";
    return s || "regular";
  }

  const ethicalToggle  = document.getElementById("ethicalModeToggle");
  const historySection = document.getElementById("history");
  const projectInput   = document.getElementById("projectId");

  const token   = getToken();
  const payload = token ? parseJwt(token) : null;
  const tokenRole = payload?.role || payload?.user_role || payload?.permissions?.role || "";
  const role = normalizeRole(tokenRole);
  const isOwner = role === "project_owner" || role === "creator";

  function updateEthicalToggleState() {
    const hasProjectId = !!(projectInput && projectInput.value.trim());
    const canUse = isOwner && hasProjectId;

    if (ethicalToggle) {
      if (!canUse) ethicalToggle.checked = false;
      ethicalToggle.disabled = !canUse;
      ethicalToggle.title = !isOwner
        ? "Only project owners can enable Ethical Mode"
        : (!hasProjectId ? "Enter a Project ID to enable Ethical Mode" : "Ethical Mode is available");
    }

    console.log("[Ethical Toggle]", { roleFromJWT: tokenRole || "(none)", normalizedRole: role, isOwner, hasProjectId, canUse });
  }

  updateEthicalToggleState();
  projectInput?.addEventListener("input",  updateEthicalToggleState);
  projectInput?.addEventListener("change", updateEthicalToggleState);

  if (historySection && !isOwner) historySection.style.display = "none";
})();

    // ====== Generic table renderer (reusable) ======
    function renderResultsTable(options) {
      const {
        buckets, ethicalMode,
        tableEl, toolsEl, countEl, filterInput,
        defaultSortKey = "risk_score", defaultSortDir = "desc"
      } = options;

      // toggle sample files column visibility (th + td)
      tableEl.querySelectorAll(".sample-col").forEach(el => el.style.display = ethicalMode ? "" : "none");

      let rows = Array.isArray(buckets) ? [...buckets] : [];
      let sortKey = defaultSortKey;
      let sortDir = defaultSortDir;

      const tbody = tableEl.querySelector("tbody");
      const thead = tableEl.querySelector("thead");

      function normalizedText(v) {
        if (v == null) return "";
        return String(v).toLowerCase();
      }

      function applyFilter() {
        const q = normalizedText(filterInput?.value || "");
        return rows.filter(b => {
          const name = normalizedText(b.bucket_name);
          const reason = normalizedText(b.risk_reason);
          const kws = Array.isArray(b.sensitive_keywords_detected)
            ? normalizedText(b.sensitive_keywords_detected.join(","))
            : normalizedText(b.sensitive_keywords_detected);
          return !q || name.includes(q) || reason.includes(q) || kws.includes(q);
        });
      }

      function sortData(arr) {
        const dir = sortDir === "asc" ? 1 : -1;
        return arr.sort((a, b) => {
          const va = (sortKey === "risk_level") ? riskLevelFromScore(a.risk_score) : a[sortKey];
          const vb = (sortKey === "risk_level") ? riskLevelFromScore(b.risk_score) : b[sortKey];

          if (sortKey === "risk_score") return (Number(va||0) - Number(vb||0)) * dir;
          if (sortKey === "public") return ((va === true ? 1 : 0) - (vb === true ? 1 : 0)) * dir;

          const sa = String(va ?? "").toLowerCase();
          const sb = String(vb ?? "").toLowerCase();
          if (sa < sb) return -1 * dir;
          if (sa > sb) return 1 * dir;
          return 0;
        });
      }

      // Build neat link list for sample files
      function buildSampleLinks(samples) {
        if (!samples) return "";
        const arr = Array.isArray(samples) ? samples : [samples];

        const items = arr.map((s) => {
          const href = String(s);
          let label = href;
          try {
            const u = new URL(href);
            const tail = u.pathname.split("/").pop() || u.host;
            label = decodeURIComponent(tail);
          } catch {
            label = decodeURIComponent(href.split("/").pop() || href);
          }
          return `<li><a class="sample-link" href="${href}" target="_blank" rel="noopener" title="${href}">${label}</a></li>`;
        }).join("");

        return `<ul class="sample-list">${items}</ul>`;
      }

      function render() {
        const filtered = sortData(applyFilter());
        tbody.innerHTML = "";
        filtered.forEach(b => {
          const level = riskLevelFromScore(b.risk_score);
          const sens = Array.isArray(b.sensitive_keywords_detected)
            ? b.sensitive_keywords_detected.join(", ")
            : (b.sensitive_keywords_detected ?? "None");

          const samplesHtml = ethicalMode && b.sample_files ? buildSampleLinks(b.sample_files) : "";

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="mono">${b.bucket_name ?? "Unknown"}</td>
            <td class="nowrap">
              ${b.public ? '<span class="badge badge-public">Public</span>' : '<span class="badge badge-private">Private</span>'}
            </td>
            <td class="nowrap mono">${b.risk_score ?? "0"}</td>
            <td class="nowrap"><span class="badge ${riskClass(level)}">${level}</span></td>
            <td>${b.risk_reason ?? "N/A"}</td>
            <td>${sens}</td>
            <td class="sample-col" style="${ethicalMode ? "" : "display:none;"}">${samplesHtml}</td>
          `;
          tbody.appendChild(tr);
        });
        if (toolsEl) toolsEl.style.display = "flex";
        if (tableEl) tableEl.style.display = "table";
        if (countEl) countEl.textContent = `${filtered.length} bucket${filtered.length===1?"":"s"}`;
        updateHeaderIndicators();
      }

      function updateHeaderIndicators() {
        thead.querySelectorAll("th").forEach(th => {
          const ind = th.querySelector(".sort-ind");
          if (!ind) return;
          const key = th.getAttribute("data-key");
          if (key === sortKey) ind.textContent = sortDir === "asc" ? "‚Üë" : "‚Üì";
          else ind.textContent = "‚Üï";
        });
      }

      thead.querySelectorAll("th[data-key]").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-key");
          if (key === sortKey) sortDir = (sortDir === "asc") ? "desc" : "asc";
          else { sortKey = key; sortDir = (key === "risk_score") ? "desc" : "asc"; }
          render();
        });
      });
      filterInput?.addEventListener("input", () => render());

      render();
    }

    // ====== RESULTS (live scan) ======
    async function runScan(projectId, ethicalMode) {
      const token = getToken();
      const resultsSummary = document.getElementById("results-summary");
      const resultsTools = document.getElementById("results-tools");
      const resultsTable = document.getElementById("results-table");
      const resultsFilter = document.getElementById("results-filter");
      const resultsCount = document.getElementById("results-count");

      resultsSummary.innerHTML = `<p>üîç Scanning in progress...</p>`;
      resultsTools.style.display = "none";
      resultsTable.style.display = "none";

      const apiUrl = `https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/scan?project_id=${encodeURIComponent(projectId)}&ethical_mode=${ethicalMode}`;

      const response = await fetch(apiUrl, {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!response.ok) {
        let msg = `Scan failed: ${response.status}`;
        try {
          const err = await response.json();
          if (err && err.detail) msg = Array.isArray(err.detail) ? err.detail.map(d => d.msg).join(", ") : err.detail;
        } catch {}
        throw new Error(msg);
      }

      const apiData = await response.json();
      const { scan_id, project_role, buckets } = apiData;

      resultsSummary.innerHTML = `
        <div class="result-card">
          <h3>Scan Summary</h3>
          <p><strong>Scan ID:</strong> ${scan_id}</p>
          <p><strong>Detected Role:</strong> ${project_role || "N/A"}</p>
          <p><strong>Bucket Count:</strong> ${Array.isArray(buckets) ? buckets.length : 0}</p>
        </div>
      `;

      renderResultsTable({
        buckets: Array.isArray(buckets) ? buckets : [],
        ethicalMode,
        tableEl: resultsTable,
        toolsEl: resultsTools,
        countEl: resultsCount,
        filterInput: resultsFilter,
        defaultSortKey: "risk_score",
        defaultSortDir: "desc"
      });

      document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    // ====== Scanner button ======
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("learn-more").addEventListener("click", async function () {
        const ethicalMode = document.getElementById("ethicalModeToggle").checked;
        const projectId = document.getElementById("projectId").value.trim();
        if (!projectId) { alert("Please enter a Project ID."); return; }

        try {
          const token = getToken();
          if (!token) { alert("You are not logged in."); return; }
          await runScan(projectId, ethicalMode);
        } catch (error) {
          document.getElementById("results-summary").innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
        }
      });
    });

    // ====== My-Scan APIs ======
    const API_PREVIOUS_SCANS = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/my-scans/";
    const API_SCAN_DETAILS = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/my-scans/{scan_id}";

    async function loadPreviousScans() {
      const tableBody = document.getElementById("previous-scan-table");
      tableBody.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";

      const token = getToken();
      if (!token) {
        tableBody.innerHTML = "<tr><td colspan='3'>Please log in to view scans</td></tr>";
        return;
      }

      try {
        const res = await fetch(API_PREVIOUS_SCANS, {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) throw new Error(`Failed to fetch scans (${res.status})`);
        const data = await res.json();
        const scans = Array.isArray(data?.my_scans) ? data.my_scans : [];

        if (scans.length === 0) {
          tableBody.innerHTML = "<tr><td colspan='3'>No scans found</td></tr>";
          return;
        }

        tableBody.innerHTML = "";
        scans.forEach(scan => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${formatDate(scan.timestamp)}</td>
            <td class="scan-id" aria-label="Click to view details">${scan.scan_id || "N/A"}</td>
            <td>${scan.project_id || "N/A"}</td>
          `;
          row.querySelector(".scan-id").addEventListener("click", () => {
            document.getElementById("scanIdInput").value = scan.scan_id;
            fetchDetailedScan();
          });
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error(error);
        tableBody.innerHTML = `<tr><td colspan='3'>Error: ${error.message}</td></tr>`;
      }
    }

    async function fetchDetailedScan() {
      const scanId = document.getElementById("scanIdInput").value.trim();
      const resultsContainer = document.getElementById("detailed-scan-results");
      const tableEl = document.getElementById("detailed-table");
      const toolsEl = document.getElementById("detailed-tools");
      const filterEl = document.getElementById("detailed-filter");
      const countEl = document.getElementById("detailed-count");

      resultsContainer.innerHTML = "<p>Loading...</p>";
      toolsEl.style.display = "none";
      tableEl.style.display = "none";

      if (!scanId) { resultsContainer.innerHTML = "<p>Please enter a Scan ID.</p>"; return; }

      const token = getToken();
      try {
        const res = await fetch(API_SCAN_DETAILS.replace("{scan_id}", encodeURIComponent(scanId)), {
          headers: { "Authorization": `Bearer ${token}` }
        });

        if (!res.ok) {
          let msg = `Scan not found (${res.status})`;
          try {
            const err = await res.json();
            if (err && err.detail) msg = Array.isArray(err.detail) ? err.detail.map(d => d.msg).join(", ") : err.detail;
          } catch {}
          throw new Error(msg);
        }

        const data = await res.json();
        const buckets = Array.isArray(data?.buckets) ? data.buckets : [];
        const ethicalMode = Boolean(data?.ethical_mode);

        resultsContainer.innerHTML = `
          <div class="result-card">
            <h4>Scan ${data.scan_id}</h4>
            <p><strong>Project:</strong> ${data.project_id || "N/A"}</p>
            <p><strong>Time:</strong> ${formatDate(data.timestamp)}</p>
            <p><strong>Role:</strong> ${data.project_role || "N/A"} | <strong>Ethical Mode:</strong> ${ethicalMode ? "On" : "Off"}</p>
            <p><strong>Bucket Count:</strong> ${buckets.length}</p>
          </div>
        `;

        if (buckets.length === 0) {
          resultsContainer.insertAdjacentHTML("beforeend", "<p>No bucket results stored for this scan.</p>");
          return;
        }

        renderResultsTable({
          buckets,
          ethicalMode,
          tableEl,
          toolsEl,
          countEl,
          filterInput: filterEl,
          defaultSortKey: "risk_score",
          defaultSortDir: "desc"
        });
      } catch (error) {
        console.error(error);
        resultsContainer.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", loadPreviousScans);

    // ====== History fetch (owner only) ======
    document.addEventListener("DOMContentLoaded", function () {
      const role = normalizeRole(localStorage.getItem("role"));
      const isOwner = role === "project_owner" || role === "creator";
      if (!isOwner) return;

      const historyTableBody = document.querySelector("#historyTable tbody");
      const apiURL = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app/history";
      const token = getToken();
      if (!token) {
        historyTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Please log in to view history</td></tr>`;
        return;
      }

      fetch(apiURL, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        }
      })
      .then(r => r.ok ? r.json() : Promise.reject(new Error(`Failed (${r.status})`)))
      .then(data => {
        historyTableBody.innerHTML = "";
        if (!Array.isArray(data) || data.length === 0) {
          historyTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No history found</td></tr>`;
          return;
        }
        data.forEach(item => {
          historyTableBody.innerHTML += `
            <tr>
              <td>${item.scan_id}</td>
              <td>${item.project_id}</td>
              <td>${item.user_email}</td>
              <td>${formatDate(item.timestamp)}</td>
              <td>${item.result_summary}</td>
            </tr>
          `;
        });
      })
      .catch(error => {
        console.error("Error fetching history:", error);
        historyTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Error loading history</td></tr>`;
      });
    });

    // ====== Optional: show stored email/role if such elements exist ======
    document.addEventListener("DOMContentLoaded", () => {
      const emailElement = document.getElementById("user-email");
      const roleElement = document.getElementById("user-role");
      const userEmail = localStorage.getItem("email");
      const userRole = localStorage.getItem("role");
      if (emailElement) emailElement.textContent = userEmail || "Unknown";
      if (roleElement) roleElement.textContent = userRole || "Unknown";
    });
  </script>

  <script src="web.js"></script>
</body>
</html>
