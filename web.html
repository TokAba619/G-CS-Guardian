<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G-CS Guardian Tool</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="web.css">
  <style>
    :root { --cyan: #E91E63; --accent:#E91E63; }

    .results-container { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
    .result-card { background: #111; padding: 1rem; border-radius: 8px; color: #eee; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .result-card h3, .result-card h4 { color: var(--cyan); margin-bottom: 0.5rem; }

    .toggle { display: flex; align-items: center; gap: 10px; }
    .toggle input { position:absolute; opacity:0; width:0; height:0; }
    .slider { width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; }
    .slider::before { content: ""; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
    .toggle input:checked + .slider::before { transform: translateX(20px); }
    .toggle input:checked + .slider { background: var(--cyan); }
    .toggle input:disabled + .slider { background:#666; cursor:not-allowed; }
    .toggle-label { color: white; }

    .navbar-brand { display: flex; align-items: center; gap: 12px; color: var(--cyan); font-size: 1.8rem; font-weight: 800; text-decoration: none; letter-spacing: 1px; text-shadow: 1px 1px 3px #000; }
    .navbar-brand .brand-logo { width: 34px; height: 34px; border-radius: 6px; object-fit: contain; display: block; background: transparent; }

    .nav-links a { color:#fff; text-decoration:none; font-size:1.1rem; font-weight:600; padding:5px 0; position:relative; transition:color .3s; }
    .nav-links a::after { content:''; position:absolute; width:0; height:2px; background: var(--cyan); left:0; bottom:0; transition:width .3s ease; }
    .nav-links a:hover::after, .nav-links a.active::after { width:100%; }
    .nav-links a:hover { color: var(--cyan); }

    .table-tools { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .table-tools input[type="text"]{ padding:.5rem .6rem; border:none; border-radius:6px; background:#1a1a1a; color:#eee; }
    .table-tools .chip { background:#1a1a1a; color:#ccc; padding:.35rem .6rem; border-radius:999px; font-size:.85rem; }

    .dashboard-table { width: 100%; border-collapse: collapse; background: #111; color: #eee; margin-top: .75rem; border-radius: 10px; overflow: hidden; }
    .dashboard-table th, .dashboard-table td { padding: 0.8rem 0.9rem; border-bottom: 1px solid rgba(255,255,255,0.08); text-align: left; vertical-align: top; }
    .dashboard-table th { background-color: var(--cyan); color: #111; position: relative; user-select:none; cursor:pointer; }
    .dashboard-table th .sort-ind { position:absolute; right:.6rem; opacity:.7; color:#000; }
    .dashboard-table tr:hover { background: rgba(255,255,255,0.05); }

    .badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; }
    .badge-public { background:#ff0000; color:#000000 !important; font-weight:700; }
    .badge-private { background:#00ff00; color:#000000 !important; font-weight:700; }
    .risk-info {background:#00eeff; color:#000000 !important; font-weight:700;}
    .risk-low { background:#00ff37; color:#000000 !important; font-weight:700; }
    .risk-medium { background:#ffee00; color:#000000 !important; font-weight:700; }
    .risk-high { background:#7a0c0c; color:#000000 !important; font-weight:700; }
    .risk-critical { background:#ff0000; color:#000000 !important; font-weight:700; }

    .mono {font-family: "Inter", sans-serif !important; }
    .nowrap { white-space: nowrap; }

    .sample-col { width: 320px; }
    .sample-list { margin: 0; padding: 0; list-style: none; display: flex; flex-direction: column; gap: .35rem; }
    .sample-link { display: inline-block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--cyan); text-decoration: underline; }
    .sample-link:hover { color: #c2185b; }

    .dashboard-table td.risk-reason { white-space: normal !important; }
    .risk-reason-list{ margin:.25rem 0; padding-left:1.1rem; }
    .risk-reason-list li{ margin:.25rem 0; line-height:1.5; }
    .risk-reason-list .tag{ display:inline-block; margin:.15rem .25rem 0 0; padding:.15rem .45rem; border-radius:999px; border:1px solid rgba(0,0,0,0.5); background: rgba(255,255,255,.08); font-size:.85em; color:#ddd; }

    .myscan-feature { margin-top: 2rem; }
    .scan-table { width: 100%; border-collapse: collapse; background: #111; color: #eee; margin-top: 1rem; border-radius: 8px; overflow: hidden; }
    .scan-table th, .scan-table td { padding: 0.75rem; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: left; }
    .scan-table th { background-color: var(--cyan); color: #111; }
    .scan-table tr:hover { background: rgba(255,255,255,0.05); }
    .scan-id { cursor: pointer; color: var(--cyan); text-decoration: underline; }
    .scan-id:hover { color: #c2185b; }
    .myscan-divider { margin: 2rem 0; border: none; height: 1px; background: rgba(255,255,255,0.2); }

    .detailed-scan-form { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .detailed-scan-form input { flex: 1; padding: 0.5rem; border-radius: 4px; border: none; }
    .detailed-scan-form button { background: var(--cyan); color: #111; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    .detailed-scan-form button:hover { background: #c2185b; color:#fff; }

    .history .table-container { overflow-x: auto; margin-top: 20px; }
    .history table { width: 100%; border-collapse: collapse; background-color: #1e1e2f; color: white; border-radius: 8px; overflow: hidden; }
    .history th, .history td { padding: 12px 15px; border-bottom: 1px solid #333; text-align: left; }
    .history th { background-color: var(--cyan); color: #000; font-weight: bold; }
    .history tr:nth-child(even) { background-color: #2a2a3d; }
    .history tr:hover { background-color: #33334d; transition: 0.2s; }

    .inline-form { display:flex; gap:12px; align-items:center; justify-content:center; max-width: 720px; margin: 18px auto 0; padding: 6px; }
    .pill-input { flex: 1; height: 52px; padding: 0 18px; border-radius: 999px; border: 1.5px solid rgba(255,255,255,.25); background: rgba(0,0,0,.35); color: #fff; outline: none; font-size: 16px; transition: border-color .2s ease, box-shadow .2s ease, background .2s ease; }
    .pill-input::placeholder { color: rgba(255,255,255,.70); }
    .pill-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(233,30,99,.16); background: rgba(0,0,0,.45); }

    .cta-pink { height: 52px; padding: 0 22px; border-radius: 999px; border: none; background: var(--accent); color: #fff; font-weight: 800; letter-spacing: .2px; cursor: pointer; white-space: nowrap; transition: transform .06s ease, box-shadow .2s ease, background .15s ease; box-shadow: 0 8px 24px rgba(233,30,99,.28); }
    .cta-pink:hover { background: #d81b60; box-shadow: 0 10px 28px rgba(233,30,99,.34); }
    .cta-pink:active { transform: translateY(1px); box-shadow: 0 6px 20px rgba(233,30,99,.28); }

    .btn-report { padding: .45rem .8rem; border-radius: 999px; border: none; background: var(--accent); color: #fff; font-weight: 700; cursor: pointer; box-shadow: 0 6px 18px rgba(233,30,99,.25); }
    .btn-report:hover { background:#d81b60; }
    .btn-report[disabled] { opacity:.6; cursor:not-allowed; }

    .form-title { font-size: 28px; font-weight: 800; text-align: center; margin-top: 18px; margin-bottom: 4px; }
    .toggle { justify-content: center; margin: 10px auto 0; }
    .scan .input-slab { margin-top: 8px; }

    @media (max-width: 640px){
      .inline-form { flex-direction: column; align-items: stretch; }
      .cta-pink { width: 100%; }
    }

    .project-picker-card { margin-top:16px; padding:16px; border-radius:12px; background:#111; }
    .picker-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .picker-actions { display:flex; gap:8px; }
    #projectSearch { padding:8px 10px; min-width:260px; border-radius:8px; border:1px solid #222; background:#0e0e0e; color:#fff; }
    #refreshProjectsBtn { padding:8px 12px; border-radius:8px; border:1px solid #222; background:var(--accent); color:#000; font-weight:600; }
    .project-table-wrap { max-height:360px; overflow:auto; border:1px solid #000; border-radius:10px; }
    .project-table { width:100%; border-collapse:separate; border-spacing:0; }
    .project-table thead th { position:sticky; top:0; background:#0d0d0d; text-align:left; padding:10px; font-weight:700; border-bottom:1px solid #222; }
    .project-table tbody td { padding:10px; border-bottom:1px solid #161616; }
    .project-table tbody tr:hover { background:#0f0f13; }
    .picker-footer { margin-top:10px; display:flex; gap:8px; align-items:center; }
    .muted { opacity:.75; }
    .error { color:#ff6b6b; }
    .badge.owner { background:#1a3; color:#d7ffd7; }
    .badge.editor { background:#332; color:#ffd; }
    .badge.viewer { background:#223; color:#ddf; }
    .badge.no_access { background:#311; color:#fdd; }
    .callout { margin-top:10px; padding:10px 12px; border-radius:10px; background:#2a1a1a; color:#ffd3d3; border:1px solid #5a2a2a; display:none; }

    /* Project picker "Select" button styles */
.project-table button.select-btn{
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid #333;
  background: #1a1a1a;
  color: #ddd;
  font-weight: 600;
  cursor: pointer;
  transition: background .15s ease, border-color .15s ease, color .15s ease, box-shadow .15s ease;
}
.project-table button.select-btn:hover { background:#222; }

.project-table button.select-btn.selected{
  background: #22c55e;           /* green */
  border-color: #22c55e;
  color: #0b1a0b;
  box-shadow: 0 0 0 3px rgba(34,197,94,.25);
}

/* (optional) also tint the whole selected row slightly */
.project-table tr.is-selected { background:#0f1a12; }

/* 1) Make Sample Files column slimmer */
#results-table th[data-key="sample_files"],
#detailed-table th[data-key="sample_files"],
.sample-col {
  width: 10%;          /* you can tweak: 8–14% */
  min-width: 140px;    /* don’t let it get too tiny */
  max-width: 200px;    /* keeps it narrow */
  overflow: hidden;    /* content will scroll inside .cell-scroll */
}

/* 2) Only the content in that cell can scroll horizontally */
.sample-col .cell-scroll {
  display: block;
  max-width: 100%;
  overflow-x: auto;    /* <-- gives you the little left-right scroller */
  overflow-y: hidden;
  white-space: nowrap; /* keeps long filenames on one line */
}

/* Wider Risk Reason for readability */
.risk-reason-col {
  width: 36%;
  min-width: 420px;
}

/* If something else overrides widths, add !important as a last resort */
/* .risk-reason-col { width: 36% !important; min-width: 420px !important; } */

/* Optional: be kind to small screens */
@media (max-width: 900px) {
  .risk-reason-col { width: 30%; min-width: 340px; }
}

/* Ensure the table can scroll horizontally if columns get wide */
.table-container,
.project-table-wrap { /* or whatever wrapper you use */
  overflow-x: auto;
}

.kw-chip{
  display:inline-block;
  padding:.2rem .5rem;
  border-radius:999px;
  background:#1a1a1a;
  border:1px solid rgba(255,255,255,.14);
  white-space:nowrap;
  margin:.15rem .25rem .15rem 0;
}

/* Make Risk Reason column wider and easy to read */
#results-table .risk-reason-col,
#detailed-table .risk-reason-col {
  width: 36%;
  min-width: 420px;
}

/* Keep the bullet list pleasant */
.risk-reason-list {
  margin: .25rem 0;
  padding-left: 1.2rem;
}

/* Optional: on smaller screens, shrink a little */
@media (max-width: 1024px){
  #results-table .risk-reason-col,
  #detailed-table .risk-reason-col {
    width: 32%;
    min-width: 360px;
  }
}
  </style>
</head>
<body>
  <nav class="navbar" id="navbar">
    <a href="index.html" class="navbar-brand">
      <img src="logo.png" alt="G-CS Guardian Logo" class="brand-logo">
      <span>G-CS Guardian</span>
    </a>

    <div class="hamburger-menu" id="hamburgerMenu" aria-label="Open menu" role="button" tabindex="0">
      <i class="fas fa-bars"></i>
    </div>
    <ul class="nav-links" id="navLinks" aria-label="Primary">
      <li><a href="#demo" onclick="closeMenu()">Demo</a></li>
      <li><a href="#scanner" onclick="closeMenu()">Scanner</a></li>
      <li><a href="#results" onclick="closeMenu()">Results</a></li>
      <li><a href="#live-reports" onclick="closeMenu()">Live Reports</a></li>
      <li><a href="#myscan" onclick="closeMenu()">My-Scan</a></li>
      <li><a href="#history" onclick="closeMenu()">History</a></li>
    </ul>
  </nav>


  <!-- DEMO SECTION -->
  <section class="content-section demo" id="demo">
    <div class="container">
      <h2 class="section-title">Watch the Demo</h2>
      <p class="section-content">See how our tool scans your Google Cloud Storage buckets...</p>
      <div class="video-wrapper">
        <video controls>
          <source src="vid3.mp4" type="video/mp4">
        </video>
      </div>
    </div>
  </section>

  <!-- SCAN SECTION -->
  <section class="content-section scan" id="scanner">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>
    <div class="container">
      <h2 class="section-title">Welcome to G-CS Guardian Scanner</h2>
      <p class="section-content">Need a Quick Scan of Your Cloud Storage Bucket? I’m ready!</p>

      <div class="form">
        <form id="scanForm" class="input-slab">
          <label class="toggle" id="ethicalModeLabel">
            <input type="checkbox" id="ethicalModeToggle" aria-label="Ethical Mode (Project Owner Only)">
            <span class="slider"></span>
            <span class="toggle-label">Full Access Scan (Project Owner)</span>
          </label>

          <!-- PROJECT PICKER -->
          <section class="card project-picker-card" aria-labelledby="pickerTitle">
            <div class="picker-header">
              <h3 id="pickerTitle">Select a GCP Project</h3>
              <div class="picker-actions">
                <input id="projectSearch" type="text" placeholder="Search by Name or ID" />
                <button id="refreshProjectsBtn" type="button">Refresh</button>
              </div>
            </div>

            <div id="projectsLoading" class="muted">Loading your projects…</div>
            <div id="projectsError" class="error" style="display:none"></div>
            <div id="scopeCallout" class="callout">Your login session is missing Google Cloud permissions (cloud-platform). Please log out and sign in again, and accept the permissions prompt.</div>

            <div class="project-table-wrap" aria-live="polite">
              <table id="projectTable" class="project-table" aria-label="GCP projects">
                <thead>
                  <tr>
                    <th style="width:38%">Name</th>
                    <th style="width:38%;">ID</th>
                    <th style="width:14%">Access level</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="picker-footer">
              <span class="muted">Selected:</span>
              <strong id="selectedProjectLabel">—</strong>
            </div>
          </section>

<br><br>
            <button id="learn-more" type="button" class="cta-pink" aria-label="Scan">Scan</button>
          </div>
        </form>
      </div>
    </div>
  </section>

<!-- RESULTS SECTION -->
<section class="content-section results" id="results">
  <div class="container">
    <h2 class="section-title">Your Scan is Complete!</h2>
    <p class="section-content">
      This report provides detailed insights into the configuration status of your scanned Google Cloud Storage buckets.
    </p>

    <!-- Loader (hidden by default) -->
    <div id="scan-loader" class="scan-loader" aria-live="polite">
      <div class="loader-wrapper">
        <span class="loader-letter">S</span>
        <span class="loader-letter">C</span>
        <span class="loader-letter">A</span>
        <span class="loader-letter">N</span>
        <span class="loader-letter">N</span>
        <span class="loader-letter">I</span>
        <span class="loader-letter">N</span>
        <span class="loader-letter">G</span>

        <div class="loader-bg-1"></div>
        <div class="loader-bg-2"></div>
        <div class="loader"></div>
      </div>
    </div>

    <!-- Summary (scan id, role, bucket count, etc.) -->
    <div id="results-summary" class="results-container"></div>

    <!-- Tools -->
    <div class="table-tools" id="results-tools" style="display:none;">
      <input
        type="text"
        id="results-filter"
        placeholder="Filter buckets (bucket name)…"
        aria-label="Filter buckets"
      />
      <span class="chip" id="results-count">0 buckets</span>
    </div>

    <!-- Cards container (replaces the old table) -->
    <div id="results-cards" class="results-cards" aria-live="polite">
      <!-- Cards are injected here by JS -->
    </div>
  </div>
</section>



<!-- LIVE REPORTS -->
<section class="content-section live-reports" id="live-reports">
  <div class="container">
    <h2 class="section-title">Live Reports</h2>
    <p class="section-content">
      Real-time insights for the latest scan of the currently selected project.
    </p>

    <!-- Header controls -->
    <div class="lr-header">
      <div class="lr-project">
        <span>Project:</span>
        <strong id="lr-project-label">—</strong>
      </div>

     <!-- put this right under the header controls in your Live Reports section -->
     <input type="date" id="lr-from" hidden>
     <input type="date" id="lr-to"   hidden>


      <button id="lr-refresh" class="cta-pink">Refresh</button>
    </div>

<div class="lr-quick">
      <button class="chip" data-range="latest">Latest</button>
      <button class="chip" data-range="today">Today</button>
      <button class="chip" data-range="all">All</button>
</div>

    <!-- KPI tiles -->
    <div class="lr-kpis">
      <div class="card">
        <div class="card-title">Total Scans</div>
        <div id="kpi-total-scans" class="kpi-val">—</div>
      </div>
      <div class="card">
        <div class="card-title">Buckets Scanned</div>
        <div id="kpi-buckets" class="kpi-val">—</div>
      </div>
      <div class="card">
        <div class="card-title">Risky Buckets</div>
        <div id="kpi-risky" class="kpi-val">—</div>
      </div>
      <div class="card">
        <div class="card-title">Risky %</div>
        <div id="kpi-risky-pct" class="kpi-val">—</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="lr-charts">
      <div class="card">
        <div class="card-title">Risk Levels</div>
        <canvas id="chart-risk-levels" height="260"></canvas>
      </div>
      <div class="card">
        <div class="card-title">Exposure (Public vs Private)</div>
        <canvas id="chart-exposure" height="260"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Risk Trend of this Project</div>
      <canvas id="chart-trend" height="220"></canvas>
    </div>

    <!-- Top risks table -->
    <div class="card">
      <div class="card-title">Top Risks</div>
      <div class="table-wrap">
        <table class="scan-table">
          <thead>
            <tr>
              <th>Bucket</th>
              <th>Risk</th>
              <th>Exposure</th>
              <th>Keywords</th>
              <th>Last Seen</th>
            </tr>
          </thead>
          <tbody id="lr-toprisks-body">
            <tr><td colspan="5" style="text-align:center;">—</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>


  <!-- MY-SCAN SECTION -->
  <section class="content-section myscan" id="myscan">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div><div class="floating-element"></div>
    </div>
    <div class="container">
      <h2 class="section-title">My-Scan</h2>
      <p class="section-content">My-Scan lets you review past scans without rescanning the same project.</p>

    <div class="myscan-feature">
  <h3>Previous Scans</h3>
  <p>View all your previous scans with timestamps and IDs.</p>

  <!-- ✅ Add scrollable wrapper here -->
  <div class="my-scan-table-wrapper">
    <table class="scan-table">
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Scan ID</th>
          <th>Project ID</th>
          <th class="download-col">Download Report</th>
        </tr>
      </thead>
      <tbody id="previous-scan-table">
        <tr>
          <td colspan="4">Loading...</td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- ✅ End wrapper -->

</div>

      <hr class="myscan-divider">

      <div class="myscan-feature">
        <h3>Detailed Scan Results</h3>
        <p>Enter a Scan ID to retrieve detailed scan information.</p>
        <div class="detailed-scan-form">
          <input type="text" id="scanIdInput" placeholder="Enter Scan ID" aria-label="Enter Scan ID">
          <button onclick="fetchDetailedScan()" aria-label="Fetch scan details">Enter</button>
        </div>

        <div id="detailed-scan-results" class="results-container" style="margin-top:1rem;"></div>

        <div class="table-tools" id="detailed-tools" style="display:none;">
          <input type="text" id="detailed-filter" placeholder="Filter buckets (name, reason, keyword)..." aria-label="Filter buckets">
          <span class="chip" id="detailed-count">0 buckets</span>
        </div>

        <!-- NEW: Card grid target -->
<div id="detailed-cards" class="results-cards"></div>

        <table class="dashboard-table" id="detailed-table" style="display:none;">
          <thead>
            <tr>
              <th data-key="bucket_name">Bucket Name<span class="sort-ind">↕</span></th>
              <th data-key="public" class="nowrap">Status<span class="sort-ind">↕</span></th>
              <th data-key="risk_score" class="nowrap">Risk Score<span class="sort-ind">↕</span></th>
              <th data-key="risk_level" class="nowrap">Risk Level<span class="sort-ind">↕</span></th>
              <th data-key="risk_reason" class="risk-reason-col">Risk Reason <span class="sort-ind">↕</span></th>
              <th data-key="sensitive_keywords_detected">Sensitive Keywords<span class="sort-ind">↕</span></th>
              <th data-key="sample_files" class="sample-col" style="display:none;">Sample Files<span class="sort-ind">↕</span></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HISTORY SECTION (updated, owner/creator with project filter) -->
  <section class="content-section history" id="history">
    <div class="floating-elements">
      <div class="floating-element"></div><div class="floating-element"></div>
      <div class="floating-element"></div><div class="floating-element"></div>
      <div class="floating-element"></div>
    </div>
    <div class="container">
      <h2 class="section-title">History</h2>
      <p class="section-content">
        Project Owners can view history for their project (enter your Project ID). Creators can view all scans or filter by Project ID.
      </p>

      <div class="inline-form" style="max-width:720px;margin-top:10px;">
        <input type="text" class="pill-input" id="historyProjectId"
               placeholder="Enter Project ID (required for Project Owner)"
               aria-label="Project ID for history">
        <button id="historyFetchBtn" type="button" class="cta-pink">Filter</button>
      </div>
      <p id="historyHint" class="muted" style="text-align:center;margin-top:8px;"></p>

      <div class="table-container" style="margin-top:18px;">
        <table id="historyTable">
          <thead>
            <tr><th>Scan ID</th><th>Project ID</th><th>User Email</th><th>Timestamp</th><th>Result Summary</th></tr>
          </thead>
          <tbody>
            <tr><td colspan="5" style="text-align:center;">Waiting…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <a href="#demo" class="scroll-top" aria-label="Back to top">
  <i data-feather="chevron-up"></i></a>

<script>
/* =========================
   CONFIG
========================= */
var API_BASE = "https://gcp-bucket-detector-backend-661175673686.us-central1.run.app";
var CONSENT_ENDPOINT   = API_BASE + "/consent";
var CONSENT_ME_ENDPOINT= API_BASE + "/consent/me";
var CONSENT_VERSION    = "pp-v1.0";

/* Helpers */
function scrollToSection(id){var el=document.getElementById(id);if(el)el.scrollIntoView({behavior:"smooth"});}
function getToken(){return localStorage.getItem("access_token");}
function formatDate(ts){
  if(ts==null)return"N/A";
  function toDate(v){
    if(typeof v==="number"){var ms=v<1e12?v*1000:v;return new Date(ms);}
    if(typeof v==="string"){
      var s=v.trim();
      if(/^\d+$/.test(s)){var n=parseInt(s,10);return new Date(n<1e12?n*1000:n);}
      var iso=s.replace(" ","T");if(!/[zZ]|[+\-]\d\d:?\d\d$/.test(iso))iso+="Z";
      var d1=new Date(iso);if(!isNaN(d1))return d1;
    }
    var d2=new Date(v);return isNaN(d2)?null:d2;
  }
  var d=toDate(ts);if(!d)return"N/A";
  var fmt=new Intl.DateTimeFormat(undefined,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"2-digit",second:"2-digit",timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,timeZoneName:"short"});
  return fmt.format(d);
}
function riskLevelFromScore(score){var s=Number(score||0);if(s>=10)return"Critical";if(s>=7)return"High";if(s>=4)return"Medium";return"Low";}
function riskClass(level){switch((level||"").toLowerCase()){case"critical":return"risk-critical";case"high":return"risk-high";case"medium":return"risk-medium";default:return"risk-low";}}

/* Mobile nav */
var navLinks=document.getElementById("navLinks");
var hamburgerMenu=document.getElementById("hamburgerMenu");
function closeMenu(){if(navLinks)navLinks.classList.remove("open");}
if(hamburgerMenu){
  hamburgerMenu.addEventListener("click",function(){if(navLinks)navLinks.classList.toggle("open");});
  hamburgerMenu.addEventListener("keydown",function(e){if(e.key==="Enter"||e.key===" "){if(navLinks)navLinks.classList.toggle("open");}});
}

/* Auth guard */
(function(){var t=getToken();if(!t)window.location.href="signup.html";})();

/* =========================
   PROJECT PICKER
========================= */
(function(){
  var els={
    table:document.getElementById("projectTable"),
    tbody:document.querySelector("#projectTable tbody"),
    search:document.getElementById("projectSearch"),
    refresh:document.getElementById("refreshProjectsBtn"),
    loading:document.getElementById("projectsLoading"),
    error:document.getElementById("projectsError"),
    callout:document.getElementById("scopeCallout"),
    selectedLabel:document.getElementById("selectedProjectLabel"),
    ethicalToggle:document.getElementById("ethicalModeToggle")
  };

  var state={
    projects:[],
    filtered:[],
    selected:{
      id:localStorage.getItem("selected_project_id")||null,
      access:localStorage.getItem("selected_project_access")||null,
      name:localStorage.getItem("selected_project_name")||null
    }
  };

  function fetchJSON(path){
    var token=getToken(); if(!token) return Promise.reject(new Error("Missing access token."));
    return fetch(API_BASE+path,{headers:{"Authorization":"Bearer "+token}})
      .then(function(res){ if(!res.ok) return res.text().then(function(t){throw new Error(t||("HTTP "+res.status));}); return res.json();});
  }

  function escapeHtml(s){return String(s).replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c];});}

  function applySelectionLabel(){
    var s=state.selected;
    els.selectedLabel.textContent = s.id ? ((s.name||"")+" ("+s.id+") — "+s.access) : "—";
  }

  function applyEthicalToggleState(){
    var isOwner = state.selected.access === "owner";
    if(!els.ethicalToggle) return;
    if(!isOwner) els.ethicalToggle.checked = false;
    els.ethicalToggle.disabled = !isOwner;
    els.ethicalToggle.title = isOwner ? "You are Owner for this project" : "Full Access Scan requires Owner access.";
  }

  /* highlight the chosen row/button */
  function updateButtons(){
    var current = state.selected && state.selected.id;
    els.tbody.querySelectorAll("tr").forEach(function(tr){
      var id = tr.getAttribute("data-id");
      var isSel = current && id === current;
      tr.classList.toggle("is-selected", !!isSel);
      var btn = tr.querySelector("button.select-btn");
      if(btn){
        btn.classList.toggle("selected", !!isSel);
        btn.textContent = isSel ? "Selected" : "Select";
        btn.setAttribute("aria-pressed", isSel ? "true" : "false");
      }
    });
  }

  function renderTable(rows){
    els.tbody.innerHTML="";
    if(!rows.length){
      els.tbody.innerHTML="<tr><td colspan='4' class='muted'>No projects found.</td></tr>";
      return;
    }

    rows.forEach(function(p){
      var isSel = state.selected && state.selected.id === p.id;
      var tr=document.createElement("tr");
      tr.setAttribute("data-id", p.id);
      tr.setAttribute("data-name", p.name || "");
      tr.setAttribute("data-access", p.access_level);

tr.addEventListener("click", function(){
  selectProject({
    id: p.id,
    name: p.name,
    access: p.access_level
  });
});


      tr.innerHTML =
        "<td>"+escapeHtml(p.name||"—")+"</td>"+
        "<td><code>"+escapeHtml(p.id)+"</code></td>"+
        "<td>"+p.access_level+"</td>";

      if(isSel) tr.classList.add("is-selected");
      els.tbody.appendChild(tr);
    });

    updateButtons();
  }

  function selectProject(sel){
    state.selected = { id:sel.id, name:sel.name, access:sel.access };
    localStorage.setItem("selected_project_id", sel.id);
    localStorage.setItem("selected_project_name", sel.name||"");
    localStorage.setItem("selected_project_access", sel.access);
    applySelectionLabel();
    applyEthicalToggleState();
    updateButtons();
    window.dispatchEvent(new CustomEvent("gcs_project_selected",{detail:state.selected}));
  }

  els.tbody.addEventListener("click", function(e){
    var btn = e.target.closest("button.select-btn");
    if(!btn) return;
    selectProject({ id:btn.dataset.id, name:btn.dataset.name, access:btn.dataset.access });
  });

  function filterRows(){
    var q=(els.search.value||"").toLowerCase().trim();
    state.filtered = !q ? state.projects.slice() : state.projects.filter(function(p){
      return (p.name||"").toLowerCase().includes(q) || (p.id||"").toLowerCase().includes(q);
    });
    renderTable(state.filtered);
  }

  function loadProjects(){
    els.error.style.display="none"; els.callout.style.display="none"; els.loading.style.display="block";
    fetchJSON("/projects").then(function(data){
      state.projects = data.projects || [];
      state.filtered = state.projects.slice();
      renderTable(state.filtered);
      if(state.selected.id){ applySelectionLabel(); applyEthicalToggleState(); updateButtons(); }
    }).catch(function(err){
      var msg=String(err.message||err);
      els.error.textContent=msg; els.error.style.display="block";
      if(/ACCESS_TOKEN_SCOPE_INSUFFICIENT|cloudresourcemanager/.test(msg)){ els.callout.style.display="block"; }
    }).finally(function(){ els.loading.style.display="none"; });
  }

  // expose getter for scan button
  window.ProjectPicker = { getSelected:function(){ return { id:state.selected.id, name:state.selected.name, access:state.selected.access }; } };

  els.refresh.addEventListener("click", loadProjects);
  els.search.addEventListener("input", filterRows);

  loadProjects();
  applySelectionLabel();
  applyEthicalToggleState();
})();


/* =========================
   RESULTS — CARD RENDER (drop-in)
   Replaces the old table renderer but keeps the same API:
   renderResultsTable({ buckets, ethicalMode, toolsEl, countEl, filterInput })
========================= */

(function(){
  // --- helpers ---
  function esc(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }
  function riskBadge(level){
    if(!level) return "";
    const key = String(level).toLowerCase();
    const cls = {
      critical:"risk-critical",
      high:"risk-high",
      medium:"risk-medium",
      low:"risk-low",
      info:"risk-info"
    }[key] || "risk-info";
    return `<span class="badge ${cls}">${esc(level)}</span>`;
  }
  function exposureBadge(state, isPublicFlag){
    // support both boolean "public" OR string exposure_state
    const isPublic = (isPublicFlag === true) || /^(public|object_public)$/i.test(String(state||""));
    return `<span class="badge ${isPublic ? "badge-public" : "badge-private"}">${isPublic ? "Public" : "Private"}</span>`;
  }
 function scoreBadge(score){
  const s = (score==null ? "—" : Number(score).toFixed(0)); // whole number
  return `<span class="badge" style="background:#fff;color:#000;font-weight:900;">Risk Score: ${s}</span>`;
}

  function reasonsHTML(reason){
    if(!reason) return `<div class="muted">No risk reasons recorded.</div>`;
    // strip keyword sentence that you show separately
    const text = String(reason).replace(/Sensitive keywords detected:[^|.]+[|.]?/ig, "").trim();
    const parts = text
      .split(/(?:\.,\s*|\. (?=[A-Z])|\s*\|\s*)/g)
      .map(s=>s.trim())
      .filter(Boolean);
    if(!parts.length) return `<div class="muted">No risk reasons recorded.</div>`;
    return `<ul class="reasons">${parts.map(p=>`<li>${esc(p)}</li>`).join("")}</ul>`;
  }
  function keywordsHTML(list){
    let kws = list;
    if(typeof kws === "string") kws = kws.split(/\s*,\s*/).filter(Boolean);
    if(!Array.isArray(kws) || !kws.length) return `<div class="muted">No sensitive keywords detected.</div>`;
    return `<div class="kw">${
      kws.map(k=>{
        const label = typeof k==="string" ? k : (k?.keyword || JSON.stringify(k));
        return `<span class="chip">${esc(label)}</span>`;
      }).join("")
    }</div>`;
  }

  // main renderer (cards)
  function renderResultsCards(buckets, opts){
    const wrap = document.getElementById("results-cards");
    if(!wrap) return;

    const filterInput = opts?.filterInput || null;
    const countEl     = opts?.countEl || null;
    const ethicalMode = !!opts?.ethicalMode;

    // helper for sample-file links
    const linkHTML = (href) => {
      let label = href;
      try{
        const u = new URL(href);
        label = decodeURIComponent(u.pathname.split("/").pop() || u.host);
      }catch(_){
        label = decodeURIComponent((href || "").split("/").pop() || href);
      }
      return `<a class="file-link" href="${esc(href)}" target="_blank" rel="noopener">${esc(label)}</a>`;
    };

    const term = (filterInput?.value || "").trim().toLowerCase();
    const filtered = (Array.isArray(buckets) ? buckets : []).filter(b => {
      if (!term) return true;
      return String(b.bucket_name || "").toLowerCase().includes(term);
    });

    if (countEl){
      const n = filtered.length;
      countEl.textContent = `${n} bucket${n===1 ? "" : "s"}`;
    }

    if (filtered.length === 0){
      wrap.innerHTML = `<div class="bucket-card"><div class="name">No matching buckets.</div></div>`;
      return;
    }

    wrap.innerHTML = filtered.map(b => {
      const name  = esc(b.bucket_name || "—");
      const expos = b.exposure_state || (b.public ? "public" : "private");
      const level = b.risk_level || riskLevelFromScore(b.risk_score); // fallback from score
      const score = b.risk_score;

      // Sample Files section (only when ethicalMode is ON and files exist)
      const filesHTML = (ethicalMode && Array.isArray(b.sample_files) && b.sample_files.length)
        ? `<div class="section files">
             <h4>Sample Files</h4>
             ${b.sample_files.map(linkHTML).join("")}
           </div>`
        : "";

      return `
        <div class="bucket-card">
          <div class="head">
            <div class="name">${name}</div>
            <div class="badges">
              ${((expos||"").toLowerCase().startsWith("public") || b.public === true)
                  ? `<span class="badge badge-public">Public</span>`
                  : `<span class="badge badge-private">Private</span>`}
              <span class="badge ${riskClass(level)}">${esc(level)}</span>
              <span class="badge" style="background:#fff;color:#000;font-weight:900;">
                Risk Score: ${ (score==null ? "—" : Number(score).toFixed(0)) }
              </span>
            </div>
          </div>

          <div class="section">
            <h4>Risk Level</h4>
            <span class="badge ${riskClass(level)}">${esc(level)}</span>
          </div>

          <div class="section">
            <h4>Risk Reasons</h4>
            ${reasonsHTML(b.risk_reason)}
          </div>

          <div class="section">
            <h4>Sensitive Keywords</h4>
            ${keywordsHTML(b.sensitive_keywords_detected)}
          </div>

          ${filesHTML}
        </div>
      `;
    }).join("");

    // show filter/count tools row
    const toolsEl = opts?.toolsEl;
    if (toolsEl) toolsEl.style.display = "flex";
  }

  // ---- PUBLIC API (compat shim) ----
  // Keep your old signature so existing calls continue to work:
  // renderResultsTable({ buckets, ethicalMode, tableEl, toolsEl, countEl, filterInput })
  window.renderResultsTable = function(opts){
    const buckets     = Array.isArray(opts?.buckets) ? opts.buckets : [];
    const toolsEl     = opts?.toolsEl || null;
    const filterInput = opts?.filterInput || null;
    const countEl     = opts?.countEl || null;

    // show tools
    if (toolsEl){ toolsEl.style.display = "flex"; }

    // keep a reference for live filtering
    window._LAST_BUCKETS = buckets;

    // initial draw
    renderResultsCards(buckets, { filterInput, countEl, ethicalMode: opts?.ethicalMode });

    // wire filter once
    if (filterInput && !filterInput._wiredForCards){
      filterInput._wiredForCards = true;
      filterInput.addEventListener("input", ()=>{
        renderResultsCards(window._LAST_BUCKETS || [], { filterInput, countEl, ethicalMode: opts?.ethicalMode });
      });
    }

    // hide old table if it exists
    if (opts?.tableEl) { opts.tableEl.style.display = "none"; }
  };

})();


/* =========================
   CONSENT HELPERS (new)
========================= */
function hasLocalConsent(){
  return localStorage.getItem("consent_given")==="true" &&
         localStorage.getItem("consent_version")===CONSENT_VERSION;
}
async function getConsentMe(){
  var token=getToken(); if(!token) throw new Error("No token");
  var res=await fetch(CONSENT_ME_ENDPOINT,{headers:{Accept:"application/json","Authorization":"Bearer "+token}});
  if(!res.ok) throw new Error("GET /consent/me -> "+res.status);
  return res.json();
}
async function postConsentWithAuth(){
  var token=getToken(); if(!token) throw new Error("No token");
  var res=await fetch(CONSENT_ENDPOINT,{
    method:"POST",
    headers:{Accept:"application/json","Content-Type":"application/json","Authorization":"Bearer "+token},
    body:JSON.stringify({version:CONSENT_VERSION})
  });
  if(!res.ok) throw new Error("POST /consent -> "+res.status);
  try{await res.json();}catch(_){}
}
async function ensureConsentBeforeScan(){
  // 1) backend already has consent?
  try{
    var me=await getConsentMe();
    if(me && me.consent_given===true && me.consent_version===CONSENT_VERSION) return true;
  }catch(_){}
  // 2) if user ticked earlier (saved locally), sync now with JWT
  if(hasLocalConsent() || localStorage.getItem("consent_pending")==="true"){
    try{
      await postConsentWithAuth();
      localStorage.removeItem("consent_pending");
      var re=await getConsentMe();
      if(re && re.consent_given===true && re.consent_version===CONSENT_VERSION) return true;
    }catch(_){}
  }
  // 3) block and instruct
  var msg="Consent required before scanning. Please open the login page and tick the checkbox.";
  document.getElementById("results-summary").innerHTML =
    "<p style='color:red;'>" + msg + " <a href='signup.html'>Go to login</a></p>";
  return false;
}

function prettyKeyword(s) {
  if (!s) return "";
  // split optional source prefix like "bucket:" or "file:"
  let prefix = "", pattern = s;
  const i = s.indexOf(":");
  if (i > -1) { prefix = s.slice(0, i); pattern = s.slice(i + 1); }

  // remove common regex tokens and escapes
  pattern = pattern
    .replace(/\\b/g, "")          // word boundaries
    .replace(/^\^|\$$/g, "")      // anchors
    .replace(/\\([\\/.])/g, "$1") // unescape \. and \/
    .trim();

  return (prefix ? `${prefix}: ` : "") + pattern;
}

/* =========================
   SCAN FLOW  — card layout
========================= */
async function runScan(projectId, ethicalMode){
  const token = getToken();
  if (!token) { window.location.href = "signup.html"; return; }

  // DOM refs
  const resultsSection = document.getElementById("results");
  const resultsSummary = document.getElementById("results-summary");
  const resultsTools   = document.getElementById("results-tools");
  const resultsFilter  = document.getElementById("results-filter");
  const resultsCount   = document.getElementById("results-count");
  const scanLoader     = document.getElementById("scan-loader");

  // NEW: cards container (replaces table)
  const resultsCards   = document.getElementById("results-cards");

  // (If the old table still exists in the DOM, we just ignore/hide it)
  const legacyTable    = document.getElementById("results-table");

  // Show loader, reset UI safely
  if (resultsSummary) resultsSummary.innerHTML = "";
  if (resultsTools)   resultsTools.style.display = "none";
  if (resultsCards)   resultsCards.innerHTML = "";
  if (legacyTable)    legacyTable.style.display = "none";
  if (scanLoader)     scanLoader.classList.add("show");

  resultsSection?.scrollIntoView({ behavior: "smooth" });

  try {
    const apiUrl = `${API_BASE}/scan?project_id=${encodeURIComponent(projectId)}&ethical_mode=${ethicalMode ? "true" : "false"}`;
    const response = await fetch(apiUrl, {
      method: "GET",
      headers: { "Authorization": "Bearer " + token, "Accept": "application/json" }
    });

    if (!response.ok) {
      let detail = "";
      try {
        const err = await response.json();
        if (err?.detail) {
          detail = typeof err.detail === "string" ? ` (${err.detail})`
                                                  : ` (${JSON.stringify(err.detail)})`;
        }
      } catch {}
      throw new Error("Scan failed: " + response.status + detail);
    }

    const apiData = await response.json();

    // Hide loader
    if (scanLoader) scanLoader.classList.remove("show");

    // Summary
    if (resultsSummary) {
      const bucketsCount = Array.isArray(apiData.buckets) ? apiData.buckets.length : 0;
      resultsSummary.innerHTML = `
        <div class="result-card">
          <h3>Scan Summary</h3>
          <p><strong>Scan ID:</strong> ${apiData.scan_id ?? "—"}</p>
          <p><strong>Detected Role:</strong> ${apiData.project_role ?? "N/A"}</p>
          <p><strong>Bucket Count:</strong> ${bucketsCount}</p>
        </div>`;
    }

    // Render as CARDS via the public shim (keeps your filter/count row)
renderResultsTable({
  buckets: Array.isArray(apiData.buckets) ? apiData.buckets : [],
  ethicalMode: !!ethicalMode,
  tableEl: legacyTable,            // will be hidden by the shim
  toolsEl: resultsTools,
  countEl: resultsCount,
  filterInput: resultsFilter
});


  } catch (e) {
    if (scanLoader) scanLoader.classList.remove("show");
    if (resultsSummary) {
      resultsSummary.innerHTML = `<p style="color:red;">Error: ${e.message || e}</p>`;
    }
  }
}

/* Scan button */
document.addEventListener("DOMContentLoaded", function () {
  const btn = document.getElementById("learn-more");
  if (!btn) return;

  btn.addEventListener("click", async function () {
    // Ensure consent first
    if (!(await ensureConsentBeforeScan())) return;

    const ethicalToggleEl = document.getElementById("ethicalModeToggle");
    let ethicalMode = !!ethicalToggleEl?.checked;

    // Prefer picker selection
    const picked = (window.ProjectPicker?.getSelected?.()) || { id: null, access: null };

    // Fallback to typed input (guard if input missing)
    const projectIdInputEl = document.getElementById("projectId");
    const typed = projectIdInputEl ? (projectIdInputEl.value || "").trim() : "";
    const projectId = picked.id || typed;

    if (!projectId) { alert("Please select a project (or type one)."); return; }

    // Ethical mode allowed only if selected project and you’re Owner
    const selectedAccess = String(picked.access || "").toLowerCase();
    const isOwner = (selectedAccess === "owner");
    if (ethicalMode && !isOwner) {
      ethicalMode = false;
      if (ethicalToggleEl) ethicalToggleEl.checked = false;
      alert("Full Access Scan requires Owner access on the SELECTED project. It has been turned off.");
    }

    runScan(projectId, ethicalMode).catch(e => {
      const resultsSummary = document.getElementById("results-summary");
      if (resultsSummary) resultsSummary.innerHTML =
        "<p style='color:red;'>Error: " + (e.message || e) + "</p>";
    });
  });
});


/* =========================
   MY-SCAN (list, detail, pdf/csv/json)
========================= */
window.API_PREVIOUS_SCANS = window.API_PREVIOUS_SCANS || (API_BASE + "/my-scans/");
window.API_SCAN_DETAILS   = window.API_SCAN_DETAILS   || (API_BASE + "/my-scans/{scan_id}");
window.API_REPORT_PDF     = window.API_REPORT_PDF     || (API_BASE + "/reports/{scan_id}/report.pdf");

/* ---------- helpers ---------- */
function getFilenameFromDisposition(header, fallback){
  if(!header) return fallback + ".pdf";
  var m = /filename\*=UTF-8''([^;]+)|filename=\"?([^\";]+)\"?/i.exec(header);
  var name = decodeURIComponent((m && (m[1] || m[2])) || "");
  return name || fallback + ".pdf";
}
function csvEscape(v){
  if(v == null) return "";
  var s = String(v);
  return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
}
function bucketsToCsv(buckets){
  var header = ["bucket_name","public","risk_score","risk_level","risk_reason","sensitive_keywords","sample_files"];
  var rows = (buckets || []).map(function(b){
    var level = riskLevelFromScore(b.risk_score);
    var keywords = Array.isArray(b.sensitive_keywords_detected)
      ? b.sensitive_keywords_detected.join("; ")
      : (b.sensitive_keywords_detected || "");
    var samples = Array.isArray(b.sample_files) ? b.sample_files.join("; ") : "";
    return [
      b.bucket_name || "",
      b.public ? "public" : "private",
      b.risk_score ?? "",
      level,
      (b.risk_reason || "").replace(/\s+/g, " ").trim(),
      keywords,
      samples
    ].map(csvEscape).join(",");
  });
  return header.join(",") + "\n" + rows.join("\n");
}

/* ---------- download handlers ---------- */
// PDF
async function downloadPdf(scanId, btnEl){
  var token = getToken(); if(!token){ alert("You are not logged in."); return; }
  try{
    if(btnEl){ btnEl.disabled = true; btnEl.textContent = "Downloading…"; }
    var url = API_REPORT_PDF.replace("{scan_id}", encodeURIComponent(scanId));
    var res = await fetch(url, {
      method: "GET",
      headers: { "Authorization":"Bearer "+token, "Accept":"application/pdf" }
    });
    if(!res.ok) throw new Error("Failed to download ("+res.status+")");

    var blob = await res.blob();
    var cd = res.headers.get("Content-Disposition");
    var filename = getFilenameFromDisposition(cd, scanId);

    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
  }catch(e){ alert(e.message || "Download failed"); }
  finally{ if(btnEl){ btnEl.disabled = false; btnEl.textContent = "PDF"; } }
}

// JSON
async function downloadJson(scanId, btnEl){
  var token = getToken(); if(!token){ alert("You are not logged in."); return; }
  try{
    if(btnEl){ btnEl.disabled = true; btnEl.textContent = "Preparing…"; }
    var url = API_SCAN_DETAILS.replace("{scan_id}", encodeURIComponent(scanId));
    var res = await fetch(url, { headers:{ "Authorization":"Bearer "+token }});
    if(!res.ok) throw new Error("Fetch failed ("+res.status+")");

    var data = await res.json();
    var blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });

    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = scanId + ".json";
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
  }catch(e){ alert(e.message || "Download failed"); }
  finally{ if(btnEl){ btnEl.disabled = false; btnEl.textContent = "JSON"; } }
}

// CSV
async function downloadCsv(scanId, btnEl){
  var token = getToken(); if(!token){ alert("You are not logged in."); return; }
  try{
    if(btnEl){ btnEl.disabled = true; btnEl.textContent = "Preparing…"; }
    var url = API_SCAN_DETAILS.replace("{scan_id}", encodeURIComponent(scanId));
    var res = await fetch(url, { headers:{ "Authorization":"Bearer "+token }});
    if(!res.ok) throw new Error("Fetch failed ("+res.status+")");

    var data = await res.json();
    var csv = bucketsToCsv(Array.isArray(data && data.buckets) ? data.buckets : []);
    var blob = new Blob([csv], { type:"text/csv;charset=utf-8" });

    var a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = scanId + ".csv";
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(a.href); a.remove();
  }catch(e){ alert(e.message || "Download failed"); }
  finally{ if(btnEl){ btnEl.disabled = false; btnEl.textContent = "CSV"; } }
}

/* ---------- list previous scans ---------- */
async function loadPreviousScans(){
  var tableBody = document.getElementById("previous-scan-table");
  if (!tableBody) return;
  tableBody.innerHTML = "<tr><td colspan='4'>Loading...</td></tr>";

  var token = getToken();
  if(!token){
    tableBody.innerHTML = "<tr><td colspan='4'>Please log in to view scans</td></tr>";
    return;
  }
  try{
    var res = await fetch(API_PREVIOUS_SCANS, { headers:{ "Authorization":"Bearer "+token }});
    if(!res.ok) throw new Error("Failed to fetch scans ("+res.status+")");
    var data = await res.json();
    var scans = Array.isArray(data && data.my_scans) ? data.my_scans : [];
    if(scans.length === 0){
      tableBody.innerHTML = "<tr><td colspan='4'>No scans found</td></tr>";
      return;
    }

    tableBody.innerHTML = "";
    scans.forEach(function(scan){
      var row = document.createElement("tr");
      row.innerHTML =
        "<td>"+formatDate(scan.timestamp)+"</td>" +
        "<td class='scan-id'>"+(scan.scan_id || "N/A")+"</td>" +
        "<td>"+(scan.project_id || "N/A")+"</td>" +
        "<td class='download-col'>" +
          "<div class='download-actions'>" +
            "<button class='btn-chip btn-pdf'  data-scan='"+scan.scan_id+"'>PDF</button>" +
            "<button class='btn-chip btn-csv'  data-scan='"+scan.scan_id+"'>CSV</button>" +
            "<button class='btn-chip btn-json' data-scan='"+scan.scan_id+"'>JSON</button>" +
          "</div>" +
        "</td>";

      row.querySelector(".scan-id").addEventListener("click", function(){
        var input = document.getElementById("scanIdInput");
        if (input) input.value = scan.scan_id;
        fetchDetailedScan();
      });

      row.querySelector(".btn-pdf")
         .addEventListener("click", function(){ downloadPdf(scan.scan_id, this); });
      row.querySelector(".btn-csv")
         .addEventListener("click", function(){ downloadCsv(scan.scan_id, this); });
      row.querySelector(".btn-json")
         .addEventListener("click", function(){ downloadJson(scan.scan_id, this); });

      tableBody.appendChild(row);
    });

  }catch(error){
    console.error(error);
    tableBody.innerHTML = "<tr><td colspan='4'>Error: "+error.message+"</td></tr>";
  }
}

/* ---------- scan details (now supports cards) ---------- */
async function fetchDetailedScan(){
  var scanIdEl = document.getElementById("scanIdInput");
  var scanId = (scanIdEl ? scanIdEl.value : "").trim();

  var resultsContainer = document.getElementById("detailed-scan-results");
  var toolsEl   = document.getElementById("detailed-tools");
  var filterEl  = document.getElementById("detailed-filter");
  var countEl   = document.getElementById("detailed-count");

  // NEW: cards container (optional)
  var cardsEl   = document.getElementById("detailed-cards");

  // Legacy table (kept for fallback)
  var tableEl   = document.getElementById("detailed-table");

  if (resultsContainer) resultsContainer.innerHTML = "<p>Loading...</p>";
  if (toolsEl) { toolsEl.style.display = "none"; }
  if (tableEl) { tableEl.style.display = "none"; }
  if (cardsEl) { cardsEl.innerHTML = ""; }

  if(!scanId){
    if (resultsContainer) resultsContainer.innerHTML = "<p>Please enter a Scan ID.</p>";
    return;
  }

  var token = getToken();
  try{
    var url = API_SCAN_DETAILS.replace("{scan_id}", encodeURIComponent(scanId));
    var res = await fetch(url, { headers:{ "Authorization":"Bearer "+token }});
    if(!res.ok){
      var msg = "Scan not found ("+res.status+")";
      try{
        var err = await res.json();
        if(err && err.detail){
          msg = Array.isArray(err.detail) ? err.detail.map(function(d){ return d.msg; }).join(", ") : err.detail;
        }
      }catch(_){}
      throw new Error(msg);
    }
    var data = await res.json();
    var buckets = Array.isArray(data && data.buckets) ? data.buckets : [];
    var ethicalMode = Boolean(data && data.ethical_mode);

    if (resultsContainer) {
      resultsContainer.innerHTML =
        "<div class='result-card'>" +
          "<h4>Scan "+(data.scan_id||"")+"</h4>" +
          "<p><strong>Project:</strong> "+(data.project_id||"N/A")+"</p>" +
          "<p><strong>Time:</strong> "+formatDate(data.timestamp)+"</p>" +
          "<p><strong>Role:</strong> "+(data.project_role||"N/A")+" | <strong>Ethical Mode:</strong> "+(ethicalMode?"On":"Off")+"</p>" +
          "<p><strong>Bucket Count:</strong> "+buckets.length+"</p>" +
        "</div>";
    }

    if (buckets.length === 0){
      resultsContainer?.insertAdjacentHTML("beforeend", "<p>No bucket results stored for this scan.</p>");
      return;
    }

    // Prefer card layout if the container is present; else fall back to table
    if (cardsEl && typeof renderResultsCards === "function"){
      renderResultsCards({
        buckets: buckets,
        ethicalMode: ethicalMode,
        targetEl: cardsEl,
        toolsEl: toolsEl,
        countEl: countEl,
        filterInput: filterEl
      });
    } else {
      // fallback: old table
      if (typeof renderResultsTable === "function"){
        renderResultsTable({
          buckets: buckets,
          ethicalMode: ethicalMode,
          tableEl: tableEl,
          toolsEl: toolsEl,
          countEl: countEl,
          filterInput: filterEl,
          defaultSortKey: "risk_score",
          defaultSortDir: "desc"
        });
      } else {
        resultsContainer?.insertAdjacentHTML("beforeend",
          "<p style='color:#f66'>Renderer missing: add #detailed-cards or include renderResultsTable/renderResultsCards.</p>");
      }
    }
  }catch(error){
    console.error(error);
    if (resultsContainer) resultsContainer.innerHTML = "<p style='color:red;'>Error: "+error.message+"</p>";
  }
}

document.addEventListener("DOMContentLoaded", loadPreviousScans);


/* =========================
   HISTORY (Owner/Creator)
   Client never blocks — server enforces auth.
========================= */
function normalizeRole(r){
  const s = String(r||"").trim().toLowerCase();
  if (["project_owner","project owner","owner"].includes(s)) return "project_owner";
  if (s === "creator") return "creator";
  return "user";
}

function getCurrentRole() {
  // Prefer explicit role if present
  let role = (localStorage.getItem("role") || "").trim().toLowerCase();
  if (role) return role;

  // Fall back to selected project access saved by the picker
  const access = (localStorage.getItem("selected_project_access") || "").trim().toLowerCase();
  if (access === "owner") return "project_owner";
  if (access === "creator") return "creator";
  return "user";
}

async function loadHistory(projectId, limit=100, offset=0){
  const token = getToken();
  const tbody = document.querySelector("#historyTable tbody");
  if (!tbody) return;

  if (!token){
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Please log in</td></tr>";
    return;
  }

  const params = new URLSearchParams();
  if (projectId) params.set("project_id", projectId);
  params.set("limit", String(limit));
  params.set("offset", String(offset));

  tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading…</td></tr>";

  try{
    const resp = await fetch(API_BASE + "/history?" + params.toString(), {
      headers: { "Accept":"application/json", "Authorization":"Bearer " + token }
    });

    if (resp.status === 403){
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#ff6b6b;'>403: Not authorized for this request.</td></tr>";
      return;
    }
    if (!resp.ok) throw new Error("Failed (" + resp.status + ")");

    const data = await resp.json();
    const rows = Array.isArray(data?.history) ? data.history : [];
    if (!rows.length){
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No history found.</td></tr>";
      return;
    }

    tbody.innerHTML = "";
    rows.forEach(item=>{
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>"+(item.scan_id||"")+"</td>"+
        "<td>"+(item.project_id||"")+"</td>"+
        "<td>"+(item.user_email||"")+"</td>"+
        "<td>"+formatDate(item.timestamp)+"</td>"+
        "<td>"+(item.result_summary||"")+"</td>";
      tbody.appendChild(tr);
    });
  }catch(err){
    console.error("History error:", err);
    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:#ff6b6b;'>Error loading history: "+(err.message||err)+"</td></tr>";
  }
}

document.addEventListener("DOMContentLoaded", function(){
  const projectInput = document.getElementById("historyProjectId");
  const fetchBtn     = document.getElementById("historyFetchBtn");
  const hint         = document.getElementById("historyHint");
  const tbody        = document.querySelector("#historyTable tbody");
  if (!projectInput || !fetchBtn || !hint || !tbody) return;

  // Determine role (used only for hints / default behavior)
  let role = normalizeRole(getCurrentRole());

  // Prefill from picker if available
  projectInput.value = localStorage.getItem("selected_project_id") || "";

  // Friendly hint (no blocking)
  if (role === "project_owner") {
    hint.textContent = "Enter your Project ID and click Filter. (The server will verify your ownership.)";
  } else if (role === "creator") {
    hint.textContent = "As Creator, you can fetch all scans or filter by Project ID.";
    // Auto-load all to start
    loadHistory("", 100, 0);
  } else {
    hint.textContent = "History is restricted to Project Owners and Creators. You can still try a Project ID — the server will verify.";
  }

  // Filter click — let server enforce permissions
  fetchBtn.addEventListener("click", function(){
    const pid = (projectInput.value || "").trim();
    // For creators, empty pid -> all; for owners/users, allow trying with a PID
    if (!pid && role !== "creator"){
      alert("Please enter a Project ID.");
      return;
    }
    loadHistory(pid, 100, 0);
  });

  // If user selects a new project in the picker, update inputs and hint
  window.addEventListener("gcs_project_selected", (ev)=>{
    try{
      if (ev?.detail?.id){
        localStorage.setItem("selected_project_id", ev.detail.id);
        localStorage.setItem("selected_project_access", (ev.detail.access||"").toLowerCase());
        projectInput.value = ev.detail.id;
      }
    }catch(_){}
    role = normalizeRole(getCurrentRole());
    if (role === "creator"){
      hint.textContent = "As Creator, you can fetch all scans or filter by Project ID.";
      loadHistory("", 100, 0);
    } else if (role === "project_owner"){
      hint.textContent = "Enter your Project ID and click Filter. (The server will verify your ownership.)";
    } else {
      hint.textContent = "History is restricted to Project Owners and Creators. You can still try a Project ID — the server will verify.";
    }
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* =========================
   LIVE REPORTS — RANGE FILTERS (Latest | Today | All)
   FIX: “Latest” now counts exposure from the full scan, not Top Risks.
========================= */
const API_REPORTS_SUMMARY = API_BASE + "/reports/summary";
const API_REPORTS_TRENDS  = API_BASE + "/reports/trends";
const API_REPORTS_TOP     = API_BASE + "/reports/top-risks";
const API_PREVIOUS_SCANS_URL =
  (window.API_PREVIOUS_SCANS || (window.API_PREVIOUS_SCANS = API_BASE + "/my-scans/"));
const API_SCAN_DETAILS = API_BASE + "/my-scans/{scan_id}";   // <-- added

let LR_RANGE = "latest";
let LR_CHARTS = { risk:null, exposure:null, trend:null };

/* ---------- helpers ---------- */
function authFetchJSON(url){
  const t = getToken(); if(!t) throw new Error("No token");
  return fetch(url, { headers:{ "Authorization":"Bearer "+t, "Accept":"application/json" }})
    .then(async r => { if(!r.ok) throw new Error(`HTTP ${r.status} on ${url}`); return r.json(); });
}
function authFetchScanDetails(scanId){
  const t = getToken(); if(!t) throw new Error("No token");
  const url = API_SCAN_DETAILS.replace("{scan_id}", encodeURIComponent(scanId));
  return fetch(url, { headers:{ "Authorization":"Bearer "+t, "Accept":"application/json" }})
    .then(async r => { if(!r.ok) throw new Error(`HTTP ${r.status} on ${url}`); return r.json(); });
}
function isoLocalDate(d){
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function formatScanDay(ts){ return isoLocalDate(new Date(ts)); }

async function ensureProjectId(){
  // 1) If the picker already has a selection, use it
  try {
    const pick = window.ProjectPicker?.getSelected?.();
    if (pick?.id) {
      localStorage.setItem("selected_project_id", pick.id);
      return pick.id;
    }
  } catch(_) {}

  // 2) If we saved one before, use that
  const stored = localStorage.getItem("selected_project_id");
  if (stored) return stored;

  // 3) Fall back to the newest scan we can find
  const t = getToken(); 
  if (!t) return "";

  try {
    const res = await fetch(API_PREVIOUS_SCANS_URL, {
      headers:{ "Authorization":"Bearer "+t, "Accept":"application/json" }
    });
    if (!res.ok) return "";
    const data  = await res.json();
    const scans = Array.isArray(data?.my_scans) ? data.my_scans : [];
    if (!scans.length) return "";
    // newest by timestamp
    const latest = scans.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp))[0];
    if (latest?.project_id){
      localStorage.setItem("selected_project_id", latest.project_id);
      return latest.project_id;
    }
  } catch(_) {}

  return "";
}


/* Newest scan meta (scan_id + timestamp + avg_risk + counts) */
async function getLatestScanInfo(pid){
  const qs = new URLSearchParams({ project_id: pid });
  const trends = await authFetchJSON(`${API_REPORTS_TRENDS}?${qs}`);
  const points = Array.isArray(trends?.points) ? trends.points : [];
  if(!points.length) return null;
  return points.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp))[0];
}

/* ---------- renderers ---------- */
function renderKpis(summary){
  const totals = summary?.totals || {};
  const put = (id,v)=>{ const el=document.getElementById(id); if(el) el.textContent = (v ?? "—"); };
  put("kpi-total-scans", totals.total_scans ?? "—");
  put("kpi-buckets",     totals.buckets_scanned ?? "—");
  put("kpi-risky",       totals.risky_buckets ?? "—");
  put("kpi-risky-pct",   (summary?.risky_bucket_pct == null) ? "—" : (summary.risky_bucket_pct + "%"));
}

function destroyChart(id){ if(LR_CHARTS[id]){ LR_CHARTS[id].destroy(); LR_CHARTS[id]=null; } }

function renderRiskLevels(summary){
  destroyChart("risk");
  const ctx = document.getElementById("chart-risk-levels")?.getContext("2d"); if(!ctx) return;
  const counts = summary?.risk_level_counts || {};
  const order  = ["critical","high","medium","low","info"];
  const colors = ["#ff0000","#7a0c0c","#ffee00","#00ff37","#00eeff"];
  const data   = order.map(k => counts[k] || 0);

  LR_CHARTS.risk = new Chart(ctx,{
    type:"doughnut",
    data:{ labels: order.map(s=>s.toUpperCase()), datasets:[{ data, backgroundColor: colors, borderWidth:0 }] },
    options:{
      cutout:"58%",
      plugins:{ legend:{ position:"bottom", labels:{ color:"#ddd" } } }
    }
  });
}

function renderExposure(summary){
  destroyChart("exposure");
  const ctx = document.getElementById("chart-exposure")?.getContext("2d"); if(!ctx) return;
  const ec  = summary?.exposure_category_counts || {};
  const vals = [ec.private||0, ec.public||0];

  LR_CHARTS.exposure = new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Private","Public"],
      datasets:[{ data: vals, backgroundColor:["#00ff00","#ff0000"], borderColor:["#00cc00","#cc0000"], borderWidth:1 }]
    },
    options:{
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ ticks:{ color:"#ddd" }, grid:{ display:false } },
        y:{ beginAtZero:true, suggestedMax: Math.max(10, ...vals)+1, ticks:{ color:"#aaa" }, grid:{ color:"rgba(255,255,255,.08)" } }
      }
    }
  });
}

function renderTrend(trends){
  destroyChart("trend");
  const ctx = document.getElementById("chart-trend")?.getContext("2d"); if(!ctx) return;
  const points = trends?.points || [];
  const labels = points.map(p => new Date(p.timestamp).toLocaleString());
  const avg    = points.map(p => p.avg_risk ?? 0);

  LR_CHARTS.trend = new Chart(ctx,{
    type:"line",
    data:{ labels, datasets:[{ data: avg, tension:.25, fill:false, borderWidth:2, borderColor:"#ff4070", pointRadius:2 }] },
    options:{
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ ticks:{ color:"#ddd", maxRotation:0 }, grid:{ display:false } },
        y:{ beginAtZero:true, suggestedMax:10, ticks:{ color:"#aaa" }, grid:{ color:"rgba(255,255,255,.08)" } }
      }
    }
  });
}

function renderTopRisks(items){
  const tb = document.getElementById("lr-toprisks-body"); if(!tb) return;
  tb.innerHTML = "";
  if(!items || !items.length){
    tb.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No risky buckets.</td></tr>";
    return;
  }
  const badge = lvl => (lvl ? `badge ${lvl.toLowerCase()}` : "badge");
  items.forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${it.bucket_name || "—"}</td>
      <td><strong>${it.risk_score ?? "—"}</strong> <span class="${badge(it.risk_level)}">${it.risk_level || ""}</span></td>
      <td>${it.exposure_state || "—"}</td>
      <td>${it.sensitive_keyword_count ?? 0}</td>
      <td>${formatDate(it.last_seen_at)}</td>`;
    tb.appendChild(tr);
  });
}

function setRangeBadge(text){
  let b = document.getElementById("lr-range-badge");
  if(!b){
    const holder = document.querySelector(".lr-header") || document.querySelector("#live-reports .container");
    if(holder){ b=document.createElement("div"); b.id="lr-range-badge"; b.style.cssText="margin-top:6px;font-size:.85rem;opacity:.7;"; holder.appendChild(b); }
  }
  if(b) b.textContent = text ? `Loaded: ${text}` : "";
}

/* ---------- main loader ---------- */
async function loadLiveReports(){
  const pid = await ensureProjectId();
  const label = document.getElementById("lr-project-label");
  if (label) label.textContent = pid || "—";

  if (!pid){
    setRangeBadge("Select a project to see data");
    // Optional: try again shortly in case the picker just finished loading
    setTimeout(() => {
      // If user picked something after page load, this will re-render
      ensureProjectId().then(id => {
        if (id){ localStorage.setItem("selected_project_id", id); loadLiveReports(); }
      });
    }, 800);
    return;
  }

  if (LR_RANGE === "latest") {
    // 1) newest scan metadata
    const latest = await getLatestScanInfo(pid);
    if(!latest){ setRangeBadge("Latest scan"); renderKpis({totals:{}, risky_bucket_pct:null}); return; }

    // 2) fetch FULL scan details -> count ALL buckets
    const details = await authFetchScanDetails(latest.scan_id);
    const buckets = Array.isArray(details?.buckets) ? details.buckets : [];

    // 3) compute risk levels + exposure from buckets
    const levelCounts = { critical:0, high:0, medium:0, low:0, info:0 };
    let expPrivate = 0, expPublic = 0, riskyBuckets = 0;

    buckets.forEach(b=>{
      const score = Number(b.risk_score||0);
      let level = "low";
      if(score>=10) level="critical";
      else if(score>=7) level="high";
      else if(score>=4) level="medium";
      levelCounts[level]++;
      if(level==="critical"||level==="high"||level==="medium") riskyBuckets++;

      const exposure = (b.exposure_state || (b.public ? "public" : "private")).toLowerCase();
      if(exposure==="private") expPrivate++; else expPublic++;
    });

    const totalBuckets = buckets.length;
    const riskyPct = totalBuckets ? Math.round((riskyBuckets/totalBuckets)*1000)/10 : null;

    const summarySynth = {
      totals: { total_scans: 1, buckets_scanned: totalBuckets, risky_buckets: riskyBuckets },
      risky_bucket_pct: (riskyPct == null ? null : riskyPct),
      risk_level_counts: levelCounts,
      exposure_category_counts: { private: expPrivate, public: expPublic }
    };

    // 4) Top risks for that same scan (optional)
    const day = formatScanDay(latest.timestamp);
    const qsTop = new URLSearchParams({ project_id: pid, from: day, to: day, limit: "100" });
    const topRes = await authFetchJSON(`${API_REPORTS_TOP}?${qsTop}`);
    const topItemsAll = Array.isArray(topRes?.items) ? topRes.items : [];
    const topItems = topItemsAll.filter(x => x.scan_id === latest.scan_id);

    // 5) render
    setRangeBadge("Latest scan");
    renderKpis(summarySynth);
    renderRiskLevels(summarySynth);
    renderExposure(summarySynth);
    renderTrend({ points: [latest] }); // mini sparkline = the newest point
    renderTopRisks(topItems);
    return;
  }

  // ===== Today / All -> server aggregates =====
  const todayISO = isoLocalDate(new Date());
  const qs    = new URLSearchParams({ project_id: pid });
  const qsTop = new URLSearchParams({ project_id: pid, limit: "5" });

  if (LR_RANGE === "today"){
    qs.set("from", todayISO); qs.set("to", todayISO);
    qsTop.set("from", todayISO); qsTop.set("to", todayISO);
    setRangeBadge("Today");
  } else {
    setRangeBadge("All scans");
  }

  const [summary, trends, topRisks] = await Promise.all([
    authFetchJSON(`${API_REPORTS_SUMMARY}?${qs}`),
    authFetchJSON(`${API_REPORTS_TRENDS}?${qs}`),
    authFetchJSON(`${API_REPORTS_TOP}?${qsTop}`)
  ]);

  renderKpis(summary);
  renderRiskLevels(summary);
  renderExposure(summary);
  renderTrend(trends);
  renderTopRisks(topRisks?.items || []);
}

/* ---------- wiring ---------- */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("lr-refresh")?.addEventListener("click", loadLiveReports);

  // chips with class .lr-quick .chip and data-range="latest|today|all"
  document.querySelectorAll(".lr-quick .chip").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const next = btn.getAttribute("data-range");
      if (next && next !== LR_RANGE) {
        LR_RANGE = next;
        await loadLiveReports();
      }
      document.querySelectorAll(".lr-quick .chip").forEach(b=> b.classList.toggle("active", b===btn));
    });
  });

  loadLiveReports();
});

window.addEventListener("gcs_project_selected", (ev)=>{
  try{ if(ev?.detail?.id) localStorage.setItem("selected_project_id", ev.detail.id); }catch(_){}
  loadLiveReports();
});
</script>

<script src="https://unpkg.com/feather-icons"></script>
<script>window.feather && feather.replace();</script>
<script src="web.js"></script>
</body>
</html>
